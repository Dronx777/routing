<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>–ú–æ–±–∏–ª—å–Ω—ã–π –Ω–∞–≤–∏–≥–∞—Ç–æ—Ä —Å OSRM Trip</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
html,body{margin:0;padding:0;height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
#map{height:100vh;width:100vw;}
#file-input{position:absolute;z-index:1200;left:50%;transform:translateX(-50%);top:10px;background:#fff;padding:8px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.15);display:flex;gap:8px;align-items:center;flex-wrap:wrap;max-width:calc(100%-20px);}
#file-input input[type=file]{font-size:14px;}
#file-input button{font-size:15px;padding:8px 10px;border-radius:8px;border:1px solid #ccc;background:#f7f7f7;cursor:pointer;}
#info-box{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);z-index:1000;background:rgba(255,255,255,0.95);padding:10px 15px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,0.3);min-width:180px;text-align:center;font-size:16px;}
.leaflet-bottom .leaflet-control-zoom{top:50%;bottom:auto;transform:translateY(-50%);}
#centerUserBtn{position:absolute;bottom:80px;right:10px;z-index:1200;background:#fff;border:none;border-radius:50%;width:50px;height:50px;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,0.3);display:flex;justify-content:center;align-items:center;transition:transform 0.15s ease;}
#centerUserBtn:hover{transform:scale(1.1);}
#centerUserBtn svg{width:28px;height:28px;stroke:#0077cc;stroke-width:2;fill:none;}
#version-label{position:absolute;bottom:10px;left:10px;color:#000;font-size:14px;z-index:1200;text-shadow:0 0 3px rgba(0,0,0,0.7);}
#debug-container{position:absolute;top:60px;left:10px;z-index:1500;background:rgba(255,255,255,0.9);padding:8px;border-radius:8px;font-size:12px;max-width:300px;max-height:70vh;overflow:auto;}
textarea{resize:none;}
</style>
</head>
<body>

<div id="file-input">
  <input type="file" id="csvFile" accept=".csv" />
  <button id="locBtn">–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å GPS</button>
  <button id="refreshBtn">–û–±–Ω–æ–≤–∏—Ç—å</button>
  <button id="clearBtn">–û—á–∏—Å—Ç–∏—Ç—å</button>
  <button id="downloadBtn">–°–∫–∞—á–∞—Ç—å CSV</button>
</div>

<div id="info-box">
  <b>–ú–∞—Ä—à—Ä—É—Ç</b><br>
  <span id="info-distance">–î–ª–∏–Ω–∞: ‚Äî</span><br>
  <span id="info-duration">–í—Ä–µ–º—è: ‚Äî</span>
</div>

<div id="debug-container">
  <b>Debug info:</b>
  <div id="csvDataDebug"></div>
  <div id="activeRouteDebug"></div>
  <div id="osrmDebug"></div>
</div>

<div id="map"></div>

<button id="centerUserBtn">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
<circle cx="12" cy="12" r="10"/>
<line x1="12" y1="2" x2="12" y2="6"/>
<line x1="12" y1="18" x2="12" y2="22"/>
<line x1="2" y1="12" x2="6" y2="12"/>
<line x1="18" y1="12" x2="22" y2="12"/>
</svg>
</button>

<div id="version-label">–≤–µ—Ä—Å–∏—è 2.2</div>

<script>
const map = L.map('map', {zoomControl:false}).setView([51.16,71.47],12);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
L.control.zoom({position:'bottomleft'}).addTo(map);

let csvMarkersLayer = L.layerGroup().addTo(map);
let routeLayer = L.layerGroup().addTo(map);
let userMarker = null;
let autoFollow = true;
let csvData = [];
let csvFileName = '';
let userCoords = null;
let activeRouteCoords = [];
let osrmCoords = [];

const infoDistanceEl = document.getElementById('info-distance');
const infoDurationEl = document.getElementById('info-duration');

map.on('movestart zoomstart',()=>{autoFollow=false;});
function centerOnUser(zoom=15){ if(userCoords) map.flyTo(userCoords,zoom,{duration:1.0}); }
function updateUserPosition(pos){ 
  userCoords=[pos.coords.latitude,pos.coords.longitude]; 
  if(!userMarker) userMarker=L.marker(userCoords).addTo(map).bindPopup('–í—ã –∑–¥–µ—Å—å'); 
  else userMarker.setLatLng(userCoords); 
  if(autoFollow) centerOnUser(); 
}
function requestUserLocation(){ 
  if(!navigator.geolocation){alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');return;} 
  navigator.geolocation.getCurrentPosition(updateUserPosition,err=>alert('GPS –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'),{enableHighAccuracy:true}); 
}

function updateDebugInfo(){
  document.getElementById('csvDataDebug').innerHTML = `<b>csvData (${csvData.length}):</b><br>${csvData.map(p=>`lat:${p.lat}, lon:${p.lon}, status:${p.status}, comment:${p.comment}`).join('<br>')}`;
  document.getElementById('activeRouteDebug').innerHTML = `<b>activeRouteCoords (${activeRouteCoords.length}):</b><br>${activeRouteCoords.map(c=>`[${c[0]}, ${c[1]}]`).join('<br>')}`;
  document.getElementById('osrmDebug').innerHTML = `<b>OSRM Trip coords (${osrmCoords.length}):</b><br>${osrmCoords.map(c=>`[${c[1]}, ${c[0]}]`).join('; ')};`;
  document.getElementById('debug-container').style.display = 'none';
}

function buildOptimizedRoute(){
  // –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë–º —Å–ª–æ–π –º–∞—Ä—à—Ä—É—Ç–∞
  routeLayer.clearLayers();
  routeLayer = L.layerGroup().addTo(map);

  // —Ñ–∏–ª—å—Ç—Ä—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–æ–ª—å–∫–æ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "0"
  activeRouteCoords = csvData.filter(p=>String(p.status)==="0").map(p=>[Number(p.lat),Number(p.lon)]);
  osrmCoords = [...activeRouteCoords];

  updateDebugInfo();

  if(osrmCoords.length===0){
    infoDistanceEl.textContent='–î–ª–∏–Ω–∞: ‚Äî';
    infoDurationEl.textContent='–í—Ä–µ–º—è: ‚Äî';
    return;
  }

  const tripCoords = userCoords ? [userCoords, ...osrmCoords] : osrmCoords;
  const coordStr = tripCoords.map(c => `${c[1]},${c[0]}`).join(';');

  fetch(`https://router.project-osrm.org/trip/v1/driving/${coordStr}?source=first&roundtrip=false&overview=full&geometries=geojson`)
    .then(r=>r.json())
    .then(json=>{
      if(!json.trips || !json.trips.length){ alert('OSRM –Ω–µ —Å–º–æ–≥ –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç'); return; }
      const trip = json.trips[0];
      routeLayer.clearLayers();
      L.geoJSON(trip.geometry,{style:{color:'#0077cc',weight:5,opacity:0.9}}).addTo(routeLayer);

      const distanceKm = (trip.distance/1000).toFixed(2);
      infoDistanceEl.textContent = `–î–ª–∏–Ω–∞: ${distanceKm} –∫–º`;
      const totalMinutes = Math.round(trip.duration/60);
      infoDurationEl.textContent = totalMinutes<60?`${totalMinutes} –º–∏–Ω`:`${Math.floor(totalMinutes/60)} —á ${totalMinutes%60} –º–∏–Ω`;

      if(userCoords) centerOnUser(15);
    })
    .catch(err=>{ alert('–û—à–∏–±–∫–∞ OSRM'); console.error(err); });
}

function createPopup(point, marker, index){
  const container=document.createElement('div');
  container.style.display='flex'; container.style.flexDirection='column'; container.style.gap='6px';

  // LAT/LON
  const latDiv=document.createElement('div');
  latDiv.style.display='flex'; latDiv.style.gap='5px';
  const latInput=document.createElement('input');
  latInput.type='text';
  latInput.value=`${point.lat}, ${point.lon}`;
  latInput.readOnly=true;
  latInput.style.border='none';
  latInput.style.background='transparent';
  latInput.style.flexGrow='1';
  const copyBtn=document.createElement('button');
  copyBtn.textContent='üìã';
  copyBtn.title='–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
  copyBtn.addEventListener('click',()=>{ navigator.clipboard.writeText(latInput.value); copyBtn.textContent='‚úî'; setTimeout(()=>copyBtn.textContent='üìã',1000); });
  latDiv.appendChild(latInput); latDiv.appendChild(copyBtn); container.appendChild(latDiv);

  // STATUS
  const statusDiv=document.createElement('div');
  statusDiv.style.display='flex'; statusDiv.style.gap='4px';
  const statusInput=document.createElement('input');
  statusInput.type='number';
  statusInput.value=String(point.status);
  statusInput.min=0; statusInput.max=1; statusInput.style.width='50px';
  const saveBtn=document.createElement('button'); saveBtn.textContent='‚úÖ'; saveBtn.style.display='none';
  const cancelBtn=document.createElement('button'); cancelBtn.textContent='‚ùå'; cancelBtn.style.display='none';
  let originalValue=String(point.status);

  statusInput.addEventListener('input',()=>{
    let val=String(statusInput.value);
    if(val!=="0" && val!=="1"){ statusInput.value=originalValue; return; }
    if(val!==originalValue){ saveBtn.style.display='inline-block'; cancelBtn.style.display='inline-block'; } 
    else{ saveBtn.style.display='none'; cancelBtn.style.display='none'; }
  });

  saveBtn.addEventListener('click',()=>{
    let val=String(statusInput.value);
    point.status=val; csvData[index].status=val; originalValue=val;
    marker.setStyle({color:val==="0"?'red':'green',fillColor:val==="0"?'red':'green'});
    buildOptimizedRoute(); // –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –º–∞—Ä—à—Ä—É—Ç –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
  });

  cancelBtn.addEventListener('click',()=>{ statusInput.value=originalValue; saveBtn.style.display='none'; cancelBtn.style.display='none'; });

  statusDiv.appendChild(document.createTextNode('status: '));
  statusDiv.appendChild(statusInput); statusDiv.appendChild(saveBtn); statusDiv.appendChild(cancelBtn);
  container.appendChild(statusDiv);

  // COMMENT
  const commentDiv=document.createElement('div');
  commentDiv.style.display='flex'; commentDiv.style.flexDirection='column'; commentDiv.style.gap='4px';
  const commentLabel=document.createElement('span'); commentLabel.textContent='comment:';
  const commentInput=document.createElement('textarea'); commentInput.value=point.comment||""; commentInput.rows=2; commentInput.style.width='100%';
  const commentSave=document.createElement('button'); commentSave.textContent='üíæ'; commentSave.style.display='none';
  const commentCancel=document.createElement('button'); commentCancel.textContent='‚ùå'; commentCancel.style.display='none';
  let originalComment = point.comment || "";

  commentInput.addEventListener('input',()=>{
    if(commentInput.value !== originalComment){ commentSave.style.display='inline-block'; commentCancel.style.display='inline-block'; } 
    else{ commentSave.style.display='none'; commentCancel.style.display='none'; }
  });

  commentSave.addEventListener('click',()=>{
    point.comment = commentInput.value; csvData[index].comment = commentInput.value; originalComment = commentInput.value;
    commentSave.style.display='none'; commentCancel.style.display='none';
  });

  commentCancel.addEventListener('click',()=>{ commentInput.value = originalComment; commentSave.style.display='none'; commentCancel.style.display='none'; });
  commentDiv.appendChild(commentLabel); commentDiv.appendChild(commentInput); commentDiv.appendChild(commentSave); commentDiv.appendChild(commentCancel);
  container.appendChild(commentDiv);

  return container;
}

document.getElementById('csvFile').addEventListener('change', function(ev){
  const file=ev.target.files[0]; if(!file) return; csvFileName=file.name;
  Papa.parse(file,{header:true,dynamicTyping:false,skipEmptyLines:true,complete:function(results){
    const data=results.data||[]; 
    csvData=[]; 
    csvMarkersLayer.clearLayers(); 
    routeLayer.clearLayers();
    activeRouteCoords=[]; 
    osrmCoords=[];
    data.forEach((r,i)=>{
      const lat=r.lat!==undefined?r.lat:r.latitude;
      const lon=r.lon!==undefined?r.lon:r.longitude;
      const status = (r.status === "1") ? "1" : "0";
      const comment=r.comment||"";
      csvData.push({lat,lon,status,comment});
      if(status==="0") activeRouteCoords.push([Number(lat),Number(lon)]);
      const color=status==="0"?'red':'green';
      const marker=L.circleMarker([lat,lon],{radius:7,color:color,fillColor:color,fillOpacity:0.8}).addTo(csvMarkersLayer);
      marker.bindPopup(createPopup(csvData[i],marker,i),{minWidth:180});
    });
    osrmCoords = [...activeRouteCoords];
    buildOptimizedRoute();
  }});
});

document.getElementById('downloadBtn').addEventListener('click', ()=>{
  if(!csvData.length){ alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'); return; }
  const csv=Papa.unparse(csvData);
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob); 
  const link=document.createElement('a'); 
  link.href=url; 
  link.download=csvFileName||'updated.csv';
  document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url);
});

document.getElementById('locBtn').addEventListener('click',()=>{ autoFollow=true; requestUserLocation(); });
document.getElementById('refreshBtn').addEventListener('click',()=>{ buildOptimizedRoute(); });
document.getElementById('clearBtn').addEventListener('click',()=>{ csvMarkersLayer.clearLayers(); routeLayer.clearLayers(); document.getElementById('csvFile').value=''; csvData=[]; activeRouteCoords=[]; osrmCoords=[]; infoDistanceEl.textContent='–î–ª–∏–Ω–∞: ‚Äî'; infoDurationEl.textContent='–í—Ä–µ–º—è: ‚Äî'; updateDebugInfo(); });
document.getElementById('centerUserBtn').addEventListener('click',()=>{ if(userCoords){ autoFollow=true; centerOnUser(); } });
</script>
</body>
</html>
