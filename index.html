<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>–ú–æ–±–∏–ª—å–Ω—ã–π –Ω–∞–≤–∏–≥–∞—Ç–æ—Ä (–±–µ–∑ —Å–∏–º—É–ª—è—Ü–∏–∏)</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
  html,body { margin:0; padding:0; height:100%; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; }
  #map { height:100vh; width:100vw; }
  #file-input {
    position: absolute;
    z-index: 1200;
    left: 50%;
    transform: translateX(-50%);
    top: 10px;
    background: #fff;
    padding: 8px;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
    max-width: calc(100% - 20px);
  }
  #file-input input[type=file] { font-size:14px; }
  #file-input button {
    font-size:15px;
    padding:8px 10px;
    border-radius:8px;
    border:1px solid #ccc;
    background:#f7f7f7;
  }
  #info-box {
    position:absolute; bottom:10px; left:50%; transform:translateX(-50%);
    z-index:1000; background:rgba(255,255,255,0.95); padding:10px 15px; border-radius:8px;
    box-shadow:0 2px 5px rgba(0,0,0,0.3); min-width:180px; text-align:center; font-size:16px;
  }
  .leaflet-bottom .leaflet-control-zoom { top:50%; bottom:auto; transform: translateY(-50%); }
  @media (max-width:420px){
    #file-input { gap:6px; padding:6px; }
    #file-input button { padding:8px 6px; font-size:14px; }
    #info-box { font-size:13px; min-width:120px; padding:8px; }
  }
  /* –ö–Ω–æ–ø–∫–∞ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è */
  #centerUserBtn {
    position: absolute;
    bottom: 80px;
    right: 10px;
    z-index: 1200;
    background: #0077cc;
    color: #fff;
    border: none;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  }
</style>
</head>
<body>

<div id="file-input">
  <input type="file" id="csvFile" accept=".csv" />
  <button id="locBtn" type="button">–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å GPS</button>
  <button id="refreshBtn" type="button">–û–±–Ω–æ–≤–∏—Ç—å</button>
  <button id="clearBtn" type="button">–û—á–∏—Å—Ç–∏—Ç—å</button>
</div>

<div id="info-box">
  <b>–ú–∞—Ä—à—Ä—É—Ç</b><br>
  <span id="info-distance">–î–ª–∏–Ω–∞: ‚Äî</span><br>
  <span id="info-duration">–í—Ä–µ–º—è: ‚Äî</span>
</div>

<div id="map"></div>

<!-- –ö–Ω–æ–ø–∫–∞ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è -->
<button id="centerUserBtn">üìç</button>

<script>
/* ==== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞—Ä—Ç—ã ==== */
const defaultCenter = [51.16, 71.47];
const defaultZoom = 12;
const map = L.map('map', { zoomControl: false }).setView(defaultCenter, defaultZoom);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
L.control.zoom({ position: 'bottomleft' }).addTo(map);

/* ==== –°–ª–æ–∏ –∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ==== */
let csvMarkersLayer = L.layerGroup().addTo(map);
let routeLayer = L.layerGroup().addTo(map);
let followLineLayer = L.layerGroup().addTo(map);

let userCoords = null;
let userMarker = null;
let watchId = null;

let routePointsArray = [];
let lastCsvCoords = [];

const infoDistanceEl = document.getElementById('info-distance');
const infoDurationEl = document.getElementById('info-duration');

let autoFollow = true; // —Ñ–ª–∞–≥ –∞–≤—Ç–æ–ø—Ä–∏–ª–∏–ø–∞–Ω–∏—è

/* ==== –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ ==== */
function centerOnUser(zoom = 15) {
  if (userCoords && autoFollow) {
    map.setView(userCoords, zoom);
  }
}

/* ==== –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ–ø—Ä–∏–ª–∏–ø–∞–Ω–∏—è –ø—Ä–∏ —Ä—É—á–Ω–æ–º –¥–≤–∏–∂–µ–Ω–∏–∏ –∫–∞—Ä—Ç—ã ==== */
map.on('movestart zoomstart', () => {
  autoFollow = false;
});

/* ==== –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ==== */
function updateUserPosition(position) {
  userCoords = [position.coords.latitude, position.coords.longitude];

  if (!userMarker) {
    userMarker = L.marker(userCoords).addTo(map).bindPopup('–í—ã –∑–¥–µ—Å—å');
  } else {
    userMarker.setLatLng(userCoords);
  }

  userMarker.openPopup();
  centerOnUser(15);

  if (routePointsArray.length) {
    // –ø–æ–∏—Å–∫ –±–ª–∏–∂–∞–π—à–µ–π —Ç–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞
    let nearestIndex = 0;
    let minDist = Infinity;
    for (let i = 0; i < routePointsArray.length; i++) {
      const dLat = routePointsArray[i][0] - userCoords[0];
      const dLon = routePointsArray[i][1] - userCoords[1];
      const dist = dLat * dLat + dLon * dLon;
      if (dist < minDist) { minDist = dist; nearestIndex = i; }
    }

    followLineLayer.clearLayers();
    const remaining = [ userCoords, ...routePointsArray.slice(nearestIndex) ];
    L.polyline(remaining, { color: 'red', weight: 6, opacity: 0.85 }).addTo(followLineLayer);
  }
}

/* ==== –ó–∞–ø—Ä–æ—Å –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ (—Ç–æ–ª—å–∫–æ –ø–æ –∫–ª–∏–∫—É!) ==== */
function requestUserLocation() {
  if (!navigator.geolocation) {
    alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º.');
    return;
  }

  navigator.geolocation.getCurrentPosition(
    (position) => {
      updateUserPosition(position);

      if (watchId === null) {
        watchId = navigator.geolocation.watchPosition(
          updateUserPosition,
          err => console.warn('watchPosition error', err),
          { enableHighAccuracy: true, maximumAge: 1000, timeout: 15000 }
        );
      }
    },
    (error) => {
      console.error('–û—à–∏–±–∫–∞ –≥–µ–æ–ø–æ–∑–∏—Ü–∏–∏:', error);
      alert('GPS –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.');
    },
    { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
  );
}

/* ==== –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ –∏–∑ –º–∞—Å—Å–∏–≤–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç ==== */
function buildRouteFromCoords(coords) {
  routeLayer.clearLayers();
  followLineLayer.clearLayers();
  routePointsArray = [];

  let tripCoords = coords;
  if (userCoords) tripCoords = [ userCoords, ...coords ];

  const coordStr = tripCoords.map(c => `${c[1]},${c[0]}`).join(';');
  const url = `https://router.project-osrm.org/trip/v1/driving/${coordStr}?source=first&roundtrip=false&overview=full&geometries=geojson`;

  fetch(url)
    .then(r => r.json())
    .then(json => {
      if (!json.trips || !json.trips.length) {
        alert('OSRM –Ω–µ —Å–º–æ–≥ –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç.');
        return;
      }

      const trip = json.trips[0];

      routePointsArray = trip.geometry.coordinates.map(c => [c[1], c[0]]);

      L.geoJSON(trip.geometry, { style: { color: '#0077cc', weight: 5, opacity: 0.9 } })
        .addTo(routeLayer);

      const distanceKm = (trip.distance / 1000).toFixed(2);
      infoDistanceEl.textContent = `–î–ª–∏–Ω–∞: ${distanceKm} –∫–º`;

      const totalMinutes = Math.round(trip.duration / 60);
      let timeStr = (totalMinutes < 60)
        ? `${totalMinutes} –º–∏–Ω`
        : `${Math.floor(totalMinutes / 60)} —á ${totalMinutes % 60} –º–∏–Ω`;

      infoDurationEl.textContent = `–í—Ä–µ–º—è: ${timeStr}`;

      if (userCoords) centerOnUser(15);
      else map.setView(tripCoords[0], 13);
    })
    .catch(err => {
      console.error('OSRM fetch error', err);
      alert('–û—à–∏–±–∫–∞ OSRM.');
    });
}

/* ==== –ü–µ—Ä–µ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ ==== */
function rebuildRoute() {
  if (!lastCsvCoords.length) {
    alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ CSV.');
    return;
  }
  buildRouteFromCoords(lastCsvCoords);
}

/* ==== –ó–∞–≥—Ä—É–∑–∫–∞ CSV ==== */
document.getElementById('csvFile').addEventListener('change', function (ev) {
  const file = ev.target.files && ev.target.files[0];
  if (!file) return;

  Papa.parse(file, {
    header: true,
    dynamicTyping: true,
    skipEmptyLines: true,
    complete: function (results) {
      const data = results.data || [];
      const coords = data
        .filter(r => r && (r.lat !== undefined && r.lon !== undefined ||
                           r.latitude !== undefined && r.longitude !== undefined))
        .map(r => {
          const lat = (r.lat !== undefined) ? r.lat : r.latitude;
          const lon = (r.lon !== undefined) ? r.lon : r.longitude;
          return [Number(lat), Number(lon)];
        });

      if (!coords.length) {
        alert('CSV –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å lat/lon.');
        return;
      }

      csvMarkersLayer.clearLayers();
      routeLayer.clearLayers();
      followLineLayer.clearLayers();
      routePointsArray = [];

      lastCsvCoords = coords;

      coords.forEach(c => L.marker(c).addTo(csvMarkersLayer));

      buildRouteFromCoords(coords);
    },
    error: function(err) {
      console.error('PapaParse error', err);
      alert('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è CSV.');
    }
  });
});

/* ==== –ö–Ω–æ–ø–∫–∏ ==== */
document.getElementById('locBtn').addEventListener('click', requestUserLocation);
document.getElementById('refreshBtn').addEventListener('click', rebuildRoute);
document.getElementById('clearBtn').addEventListener('click', function () {
  csvMarkersLayer.clearLayers();
  routeLayer.clearLayers();
  followLineLayer.clearLayers();
  document.getElementById('csvFile').value = '';
  lastCsvCoords = [];
  routePointsArray = [];
  infoDistanceEl.textContent = '–î–ª–∏–Ω–∞: ‚Äî';
  infoDurationEl.textContent = '–í—Ä–µ–º—è: ‚Äî';
});

/* ==== –ö–Ω–æ–ø–∫–∞ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ ==== */
const centerUserBtn = document.getElementById('centerUserBtn');
centerUserBtn.addEventListener('click', () => {
  if (!userCoords) return;
  autoFollow = true;          // –≤–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–ø—Ä–∏–ª–∏–ø–∞–Ω–∏–µ
  map.setView(userCoords, 15); // —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
});
</script>

</body>
</html>
