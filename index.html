<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Мобильный навигатор с OSRM Trip</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
html,body{margin:0;padding:0;height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
#map{height:100vh;width:100vw;}
#file-input{position:absolute;z-index:1200;left:50%;transform:translateX(-50%);top:10px;background:#fff;padding:6px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.15);display:flex;gap:6px;align-items:center;flex-wrap:wrap;max-width:95%;}
#file-input input[type=file]{font-size:13px;}
#file-input button{font-size:14px;padding:6px 8px;border-radius:6px;border:1px solid #ccc;background:#f7f7f7;cursor:pointer;}
#info-box{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);z-index:1000;background:rgba(255,255,255,0.95);padding:6px 10px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,0.3);min-width:150px;text-align:center;font-size:14px;}
.leaflet-bottom .leaflet-control-zoom{top:50%;bottom:auto;transform:translateY(-50%);}
#centerUserBtn{position:absolute;bottom:80px;right:10px;z-index:1200;background:#fff;border:none;border-radius:50%;width:45px;height:45px;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,0.3);display:flex;justify-content:center;align-items:center;transition:transform 0.15s ease;}
#centerUserBtn:hover{transform:scale(1.1);}
#centerUserBtn svg{width:24px;height:24px;stroke:#0077cc;stroke-width:2;fill:none;}
#version-label{position:absolute;bottom:10px;left:10px;color:#000;font-size:12px;z-index:1200;text-shadow:0 0 3px rgba(0,0,0,0.7);}
textarea{resize:none;font-size:13px;}
button{font-size:14px;padding:4px 6px;}
.user-triangle-icon svg{display:block;}
</style>
</head>
<body>

<div id="file-input">
  <input type="file" id="csvFile" accept=".csv" />
  <button id="locBtn">GPS</button>
  <button id="refreshBtn">Обновить</button>
  <button id="clearBtn">Очистить</button>
  <button id="downloadBtn">Сохранить</button>
  <button id="navStartBtn">Старт</button>
  <button id="navStopBtn">Стоп</button>
</div>

<div id="info-box">
  <b>Маршрут</b><br>
  <span id="info-distance">Длина: —</span><br>
  <span id="info-duration">Время: —</span>
</div>

<div id="map"></div>

<button id="centerUserBtn">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
<circle cx="12" cy="12" r="10"/>
<line x1="12" y1="2" x2="12" y2="6"/>
<line x1="12" y1="18" x2="12" y2="22"/>
<line x1="2" y1="12" x2="6" y2="12"/>
<line x1="18" y1="12" x2="22" y2="12"/>
</svg>
</button>

<div id="version-label">версия 3.0</div>

<script>
const map = L.map('map', {zoomControl:false}).setView([51.16,71.47],12);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
L.control.zoom({position:'bottomleft'}).addTo(map);

let csvMarkersLayer = L.layerGroup().addTo(map);
let routeLayer = L.layerGroup().addTo(map);
let userMarker = null;
let userMarkerType = 'circle';
let userRadius = null;
let csvData = [];
let csvFileName = '';
let userCoords = null;
let activeRouteCoords = [];
let osrmCoords = [];
let navRouteCoords = [];
let navWatchId = null;
let remainingRouteLayer = null;
let autoFollow = true;

const infoDistanceEl = document.getElementById('info-distance');
const infoDurationEl = document.getElementById('info-duration');

map.on('movestart zoomstart',()=>{autoFollow=false;});

// ================= USER MARKER FUNCTIONS =================
function createUserTriangleMarker(latlng, heading=0){
    const triangleIcon = L.divIcon({
        className: 'user-triangle-icon',
        iconSize: [20, 20],
        html: `<svg width="20" height="20" viewBox="0 0 20 20" style="transform: rotate(${heading}deg); transform-origin: 50% 60%;">
            <polygon points="10,0 0,20 20,20" fill="white" stroke="black" stroke-width="1"/>
        </svg>`
    });
    return L.marker(latlng, {icon: triangleIcon});
}

function setUserMarkerToTriangle(){
    if(!userCoords) return;
    if(userMarker) map.removeLayer(userMarker);
    userMarker = createUserTriangleMarker(userCoords, getUserHeading());
    userMarker.addTo(map).bindPopup('Вы здесь');
    userMarkerType='triangle';
}

function setUserMarkerToCircle(){
    if(!userCoords) return;
    if(userMarker) map.removeLayer(userMarker);
    userMarker = L.circleMarker(userCoords,{radius:6,color:'#0077cc',fillColor:'#0077cc',fillOpacity:0.8}).addTo(map).bindPopup('Вы здесь');
    userMarkerType='circle';
}

function getUserHeading(){
    if(!navRouteCoords.length || !userCoords) return 0;
    let nearestIndex=0, minDist=Infinity;
    for(let i=0;i<navRouteCoords.length;i++){
        const dx=userCoords[0]-navRouteCoords[i][0], dy=userCoords[1]-navRouteCoords[i][1];
        const dist=Math.sqrt(dx*dx+dy*dy);
        if(dist<minDist){ minDist=dist; nearestIndex=i; }
    }
    if(nearestIndex >= navRouteCoords.length-1) nearestIndex = navRouteCoords.length-2;
    const from = navRouteCoords[nearestIndex];
    const to = navRouteCoords[nearestIndex+1];
    const angleRad = Math.atan2(to[1]-from[1], to[0]-from[0]);
    return angleRad * 180 / Math.PI;
}

// ================= USER POSITION =================
function updateUserPosition(pos){ 
  userCoords=[pos.coords.latitude,pos.coords.longitude]; 
  if(!userMarker){ 
    userMarker = L.circleMarker(userCoords,{radius:6,color:'#0077cc',fillColor:'#0077cc',fillOpacity:0.8}).addTo(map).bindPopup('Вы здесь'); 
  } else { 
    userMarker.setLatLng(userCoords);
  }
  if(!userRadius) userRadius = L.circle(userCoords,{radius:50,color:'black',weight:1,fillOpacity:0}).addTo(map);
  else userRadius.setLatLng(userCoords);
  checkPointsInUserRadius();
  if(autoFollow) centerOnUser(); 
}

// ===== Auto update points in radius =====
function checkPointsInUserRadius() {
  if(!userCoords) return;
  let changed = false;
  csvData.forEach((p,i)=>{
    if(p.status==="0"){
      const d = L.latLng(userCoords).distanceTo(L.latLng([p.lat,p.lon]));
      if(d <= 50){
        p.status="1";
        csvMarkersLayer.getLayers()[i].setStyle({color:'green', fillColor:'green'});
        changed = true;
      }
    }
  });
  if(changed) buildOptimizedRoute();
}

// ================= FUNCTIONS BUILD/START/STOP NAV =================
// (Все функции buildOptimizedRoute, startRealNavigation, stopRealNavigation, и обновления треугольника аналогично предыдущему коду)
// Отличие: треугольник плавно вращается по направлению движения через getUserHeading() и обновление иконки внутри watchPosition.
</script>
</body>
</html>
