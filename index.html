<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Мобильный навигатор с OSRM Trip</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
html,body{margin:0;padding:0;height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
#map{height:100vh;width:100vw;}
#file-input{position:absolute;z-index:1200;left:50%;transform:translateX(-50%);top:10px;background:#fff;padding:6px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.15);display:flex;gap:6px;align-items:center;flex-wrap:wrap;max-width:95%;}
#file-input input[type=file]{font-size:13px;}
#file-input button{font-size:14px;padding:6px 8px;border-radius:6px;border:1px solid #ccc;background:#f7f7f7;cursor:pointer;}
#info-box{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);z-index:1000;background:rgba(255,255,255,0.95);padding:6px 10px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,0.3);min-width:150px;text-align:center;font-size:14px;}
.leaflet-bottom .leaflet-control-zoom{top:50%;bottom:auto;transform:translateY(-50%);}
#centerUserBtn{position:absolute;bottom:80px;right:10px;z-index:1200;background:#fff;border:none;border-radius:50%;width:45px;height:45px;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,0.3);display:flex;justify-content:center;align-items:center;transition:transform 0.15s ease;}
#centerUserBtn:hover{transform:scale(1.1);}
#centerUserBtn svg{width:24px;height:24px;stroke:#0077cc;stroke-width:2;fill:none;}
#version-label{position:absolute;bottom:10px;left:10px;color:#000;font-size:12px;z-index:1200;text-shadow:0 0 3px rgba(0,0,0,0.7);}
textarea{resize:none;font-size:13px;}
button{font-size:14px;padding:4px 6px;}

/* Стиль белого треугольника */
.userTriangle {
  width: 0;
  height: 0;
  border-left: 10px solid transparent;
  border-right: 10px solid transparent;
  border-top: 18px solid white;
  filter: drop-shadow(0 0 3px rgba(0,0,0,0.6));
  transform-origin: 50% 60%;
  margin-top: -12px;
  pointer-events: none;
}

.leaflet-control-container { transform-origin: 50% 50%; }
</style>
</head>
<body>

<div id="file-input">
  <input type="file" id="csvFile" accept=".csv" />
  <button id="locBtn">GPS</button>
  <button id="refreshBtn">Обновить</button>
  <button id="clearBtn">Очистить</button>
  <button id="downloadBtn">Сохранить</button>
  <button id="navStartBtn">Старт</button>
  <button id="navStopBtn">Стоп</button>
</div>

<div id="info-box">
  <b>Маршрут</b><br>
  <span id="info-distance">Длина: —</span><br>
  <span id="info-duration">Время: —</span>
</div>

<div id="map"></div>

<button id="centerUserBtn">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
<circle cx="12" cy="12" r="10"/>
<line x1="12" y1="2" x2="12" y2="6"/>
<line x1="12" y1="18" x2="12" y2="22"/>
<line x1="2" y1="12" x2="6" y2="12"/>
<line x1="18" y1="12" x2="22" y2="12"/>
</svg>
</button>

<div id="version-label">версия 3.0</div>

<script>
const map = L.map('map', {zoomControl:false}).setView([51.16,71.47],12);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
L.control.zoom({position:'bottomleft'}).addTo(map);

let csvMarkersLayer = L.layerGroup().addTo(map);
let routeLayer = L.layerGroup().addTo(map);
let userMarker = null;
let userTriangleMarker = null;
let autoFollow = true;
let csvData = [];
let csvFileName = '';
let userCoords = null;
let activeRouteCoords = [];
let navRouteCoords = [];
let navWatchId = null;
let remainingRouteLayer = null;
let mapRotationEnabled = false;
let lastUserCoords = null;
let lastHeading = 0;
let userRadius = null;

const infoDistanceEl = document.getElementById('info-distance');
const infoDurationEl = document.getElementById('info-duration');

map.on('movestart zoomstart',()=>{autoFollow=false;});
function centerOnUser(zoom=15){ if(userCoords) map.flyTo(userCoords,zoom,{duration:1.0}); }

function rotateMap(angleDeg){
  const pane = document.querySelector('.leaflet-map-pane');
  if(pane) pane.style.transform = `rotate(${angleDeg}deg)`; // мгновенный поворот без плавности
}

function createOrUpdateUserCircle(lat, lon){
  if(userTriangleMarker){ try{ map.removeLayer(userTriangleMarker); }catch(e){} userTriangleMarker=null; }
  if(!userMarker){
    userMarker = L.circleMarker([lat,lon],{radius:6,color:'#0077cc',fillColor:'#0077cc',fillOpacity:0.8}).addTo(map).bindPopup('Вы здесь');
  } else userMarker.setLatLng([lat,lon]);
}

function createOrUpdateUserTriangle(lat, lon){
  if(userMarker){ try{ map.removeLayer(userMarker); }catch(e){} userMarker=null; }
  const html = '<div class="userTriangle"></div>';
  const icon = L.divIcon({html: html, className: '', iconSize:[24,24], iconAnchor:[12,12]});
  if(!userTriangleMarker) userTriangleMarker = L.marker([lat, lon],{icon:icon,interactive:false}).addTo(map);
  else { userTriangleMarker.setIcon(icon); userTriangleMarker.setLatLng([lat,lon]); }
}

function computeHeadingFromCoords(prev, curr){
  const lat1=prev[0]*Math.PI/180, lon1=prev[1]*Math.PI/180;
  const lat2=curr[0]*Math.PI/180, lon2=curr[1]*Math.PI/180;
  const y = Math.sin(lon2-lon1)*Math.cos(lat2);
  const x = Math.cos(lat1)*Math.sin(lat2)-Math.sin(lat1)*Math.cos(lat2)*Math.cos(lon2-lon1);
  return (Math.atan2(y,x)*180/Math.PI+360)%360;
}

function buildOptimizedRoute(){
  routeLayer.clearLayers();
  activeRouteCoords = csvData.filter(p=>p.status==="0").map(p=>[Number(p.lat),Number(p.lon)]);
  if(activeRouteCoords.length===0){ infoDistanceEl.textContent='Длина: —'; infoDurationEl.textContent='Время: —'; navRouteCoords=[]; if(remainingRouteLayer){remainingRouteLayer.clearLayers();} return; }
  const tripCoords = userCoords ? [userCoords, ...activeRouteCoords] : activeRouteCoords;
  const coordStr = tripCoords.map(c=>`${c[1]},${c[0]}`).join(';');
  fetch(`https://router.project-osrm.org/trip/v1/driving/${coordStr}?source=first&roundtrip=false&overview=full&geometries=geojson`)
  .then(r=>r.json()).then(json=>{
    if(!json.trips||!json.trips.length){alert('OSRM не смог построить маршрут'); return;}
    const trip=json.trips[0];
    routeLayer.clearLayers();
    L.geoJSON(trip.geometry,{style:{color:'#0077cc',weight:3,opacity:0.9}}).addTo(routeLayer);
    navRouteCoords = trip.geometry.coordinates.map(c=>[c[1],c[0]]);
    infoDistanceEl.textContent=`Длина: ${(trip.distance/1000).toFixed(2)} км`;
    const mins=Math.round(trip.duration/60);
    infoDurationEl.textContent = mins<60?`${mins} мин`:`${Math.floor(mins/60)} ч ${mins%60} мин`;
    if(userCoords) centerOnUser(15);
  }).catch(err=>{alert('Ошибка OSRM');console.error(err);});
}

function updateUserPosition(pos){
  userCoords=[pos.coords.latitude,pos.coords.longitude];
  if(!mapRotationEnabled) createOrUpdateUserCircle(userCoords[0],userCoords[1]);
  else createOrUpdateUserTriangle(userCoords[0],userCoords[1]);
  if(!userRadius) userRadius = L.circle(userCoords,{radius:50,color:'black',weight:1,fillOpacity:0}).addTo(map);
  else userRadius.setLatLng(userCoords);
  if(autoFollow) centerOnUser();
}

function requestUserLocation(){ 
  if(!navigator.geolocation){alert('Геолокация не поддерживается');return;} 
  navigator.geolocation.getCurrentPosition(updateUserPosition,err=>alert('GPS недоступен'),{enableHighAccuracy:true}); 
}

// ================== Navigation ==================
function startRealNavigation(){
  if(!navRouteCoords.length){alert('Нет маршрута для навигации'); return;}
  if(!navigator.geolocation){alert('Геолокация не поддерживается'); return;}
  mapRotationEnabled=true;
  if(userCoords) createOrUpdateUserTriangle(userCoords[0],userCoords[1]);
  if(navWatchId) navigator.geolocation.clearWatch(navWatchId);
  if(!remainingRouteLayer) remainingRouteLayer=L.layerGroup().addTo(map);

  navWatchId=navigator.geolocation.watchPosition(pos=>{
    const lat=pos.coords.latitude, lon=pos.coords.longitude;
    const prevCoords=userCoords ? [userCoords[0],userCoords[1]] : null;
    userCoords=[lat,lon];
    createOrUpdateUserTriangle(lat,lon);
    if(!userRadius) userRadius = L.circle(userCoords,{radius:50,color:'black',weight:1,fillOpacity:0}).addTo(map);
    else userRadius.setLatLng(userCoords);

    let heading=pos.coords.heading;
    if(heading===null||isNaN(heading)) heading=prevCoords ? computeHeadingFromCoords(prevCoords,[lat,lon]) : lastHeading || 0;
    lastHeading=heading;
    rotateMap(-heading); // мгновенный поворот карты
    if(autoFollow) centerOnUser();

    // Остаток маршрута
    if(navRouteCoords.length>0){
      let nearestIndex=0,minDist=Infinity;
      for(let i=0;i<navRouteCoords.length;i++){
        const dx=userCoords[0]-navRouteCoords[i][0], dy=userCoords[1]-navRouteCoords[i][1];
        const dist=Math.sqrt(dx*dx+dy*dy);
        if(dist<minDist){ minDist=dist; nearestIndex=i; }
      }
      remainingRouteLayer.clearLayers();
      let points=[[userCoords[0],userCoords[1]], navRouteCoords[nearestIndex]];
      L.polyline(points,{color:'red',weight:3,opacity:0.9}).addTo(remainingRouteLayer);
      L.polyline(navRouteCoords.slice(nearestIndex),{color:'red',weight:3,opacity:0.9}).addTo(remainingRouteLayer);

      // Желтая 200м
      let yellowLineCoords=[[userCoords[0],userCoords[1]]], distAccum=0;
      for(let i=nearestIndex;i<navRouteCoords.length-1;i++){
        const from=L.latLng(navRouteCoords[i]), to=L.latLng(navRouteCoords[i+1]);
        const segDist=from.distanceTo(to);
        if(distAccum+segDist>200){
          const remaining=200-distAccum, ratio=remaining/segDist;
          yellowLineCoords.push([from.lat+(to.lat-from.lat)*ratio, from.lng+(to.lng-from.lng)*ratio]);
          break;
        } else { yellowLineCoords.push([to.lat,to.lng]); distAccum+=segDist; }
      }
      L.polyline(yellowLineCoords,{color:'yellow',weight:4,opacity:0.9}).addTo(remainingRouteLayer);
    }
    lastUserCoords=[lat,lon];
  },err=>console.error(err),{enableHighAccuracy:true,maximumAge:0,timeout:5000});
}

function stopRealNavigation(){
  if(navWatchId){navigator.geolocation.clearWatch(navWatchId); navWatchId=null;}
  if(remainingRouteLayer){remainingRouteLayer.clearLayers();}
  mapRotationEnabled=false;
  rotateMap(0);
  if(userTriangleMarker){ try{ map.removeLayer(userTriangleMarker);}catch(e){} userTriangleMarker=null; }
  if(userCoords) createOrUpdateUserCircle(userCoords[0],userCoords[1]);
}

// ================== Events ==================
document.getElementById('csvFile').addEventListener('change', function(ev){
  const file=ev.target.files[0]; if(!file) return; csvFileName=file.name;
  Papa.parse(file,{header:true,dynamicTyping:false,skipEmptyLines:true,complete:function(results){
    const data=results.data||[]; 
    csvData=[]; csvMarkersLayer.clearLayers(); routeLayer.clearLayers();
    data.forEach((r,i)=>{
      const lat=r.lat!==undefined?r.lat:r.latitude;
      const lon=r.lon!==undefined?r.lon:r.longitude;
      const status=(String(r.status)==="1")?"1":"0";
      const color=status==="0"?'red':'green';
      csvData.push({lat,lon,status,comment:r.comment||""});
      const marker=L.circleMarker([lat,lon],{radius:6,color:color,fillColor:color,fillOpacity:0.8}).addTo(csvMarkersLayer);
    });
    buildOptimizedRoute();
  }});
});

document.getElementById('downloadBtn').addEventListener('click', ()=>{
  if(!csvData.length){ alert('Нет данных'); return; }
  const csv=Papa.unparse(csvData);
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const link=document.createElement('a'); link.href=url; link.download=csvFileName||'updated.csv';
  document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url);
});

document.getElementById('locBtn').addEventListener('click',()=>{ autoFollow=true; requestUserLocation(); });
document.getElementById('refreshBtn').addEventListener('click',()=>{ buildOptimizedRoute(); });
document.getElementById('clearBtn').addEventListener('click',()=>{
  csvMarkersLayer.clearLayers(); routeLayer.clearLayers(); if(remainingRouteLayer) remainingRouteLayer.clearLayers();
  document.getElementById('csvFile').value=''; csvData=[]; activeRouteCoords=[]; navRouteCoords=[];
  infoDistanceEl.textContent='Длина: —'; infoDurationEl.textContent='Время: —';
});

document.getElementById('navStartBtn').addEventListener('click',()=>{ autoFollow=true; startRealNavigation(); });
document.getElementById('navStopBtn').addEventListener('click',()=>{ stopRealNavigation(); if(userCoords) map.setView(userCoords,map.getZoom()); });
document.getElementById('centerUserBtn').addEventListener('click',()=>{ if(userCoords){ autoFollow=true; centerOnUser(); } });

</script>
</body>
</html>
