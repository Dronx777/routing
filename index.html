<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>–ú–æ–±–∏–ª—å–Ω—ã–π –Ω–∞–≤–∏–≥–∞—Ç–æ—Ä ‚Äî –ñ–∏–≤–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ OSRM Trip (–≤–µ—Ä—Å–∏—è 2)</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
  /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ ‚Äî —á–∏—Ç–∞–µ–º—ã–µ –∏ –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ */
  html,body{margin:0;padding:0;height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
  #map{height:100vh;width:100vw;}
  #file-input{
    position:absolute;z-index:1200;left:50%;transform:translateX(-50%);top:10px;
    background:#fff;padding:8px;border-radius:10px;box-shadow:0 2px 12px rgba(0,0,0,0.15);
    display:flex;gap:8px;align-items:center;flex-wrap:wrap;max-width:96%;
  }
  #file-input input[type=file]{font-size:13px;}
  #file-input button{font-size:14px;padding:6px 8px;border-radius:8px;border:1px solid #d0d0d0;background:#fafafa;cursor:pointer;}
  #info-box{
    position:absolute;bottom:10px;left:50%;transform:translateX(-50%);
    z-index:1000;background:rgba(255,255,255,0.95);padding:8px 12px;border-radius:10px;
    box-shadow:0 2px 8px rgba(0,0,0,0.18);min-width:180px;text-align:center;font-size:14px;
  }
  #centerUserBtn{position:absolute;bottom:90px;right:12px;z-index:1200;background:#fff;border:none;border-radius:50%;
    width:48px;height:48px;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,0.18);display:flex;justify-content:center;align-items:center;}
  #centerUserBtn svg{width:24px;height:24px;stroke:#0077cc;stroke-width:2;fill:none;}
  #version-label{position:absolute;bottom:10px;left:10px;color:#000;font-size:12px;z-index:1200;text-shadow:0 0 3px rgba(0,0,0,0.6);}
  textarea{resize:none;font-size:13px;}
  input[type=number]{font-size:14px;padding:2px;}
  .small{font-size:12px;color:#444;}
  /* –∞–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ */
  @media (max-width:480px){
    #file-input{left:8px;transform:none;top:8px;right:8px;}
    #info-box{left:8px;transform:none;right:8px;}
  }
</style>
</head>
<body>

<!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
<div id="file-input">
  <input type="file" id="csvFile" accept=".csv" />
  <button id="locBtn" title="–í–∫–ª—é—á–∏—Ç—å GPS">GPS</button>
  <button id="refreshBtn" title="–û–±–Ω–æ–≤–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç">–û–±–Ω–æ–≤–∏—Ç—å</button>
  <button id="navigateBtn" title="–í–∫–ª/–í—ã–∫–ª —Ä–µ–∂–∏–º –Ω–∞–≤–∏–≥–∞—Ü–∏–∏">–ù–∞–≤–∏–≥–∞—Ü–∏—è</button>
  <button id="stopNavBtn" title="–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞–≤–∏–≥–∞—Ü–∏—é">–°—Ç–æ–ø</button>
  <button id="clearBtn" title="–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë">–û—á–∏—Å—Ç–∏—Ç—å</button>
  <button id="downloadBtn" title="–°–∫–∞—á–∞—Ç—å CSV">–°–∫–∞—á–∞—Ç—å</button>
</div>

<!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
<div id="info-box">
  <div style="font-weight:600">–ù–∞–≤–∏–≥–∞—Ü–∏—è</div>
  <div class="small">–°–ª–µ–¥—É—é—â–∞—è —Ç–æ—á–∫–∞: <span id="next-point">‚Äî</span></div>
  <div id="info-distance">–î–ª–∏–Ω–∞: ‚Äî</div>
  <div id="info-duration">–í—Ä–µ–º—è: ‚Äî</div>
  <div class="small" id="nav-state">–°–æ—Å—Ç–æ—è–Ω–∏–µ: –æ–∂–∏–¥–∞–Ω–∏–µ</div>
</div>

<div id="map"></div>

<button id="centerUserBtn" title="–¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Å–µ–±–µ">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
<circle cx="12" cy="12" r="10"/>
<line x1="12" y1="2" x2="12" y2="6"/>
<line x1="12" y1="18" x2="12" y2="22"/>
<line x1="2" y1="12" x2="6" y2="12"/>
<line x1="18" y1="12" x2="22" y2="12"/>
</svg>
</button>

<div id="version-label">–≤–µ—Ä—Å–∏—è 4.0 ‚Äî —Ä–µ–∞–ª—å–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è</div>

<script>
/* ====================
   –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ —Å–ª–æ–∏
   ==================== */
const map = L.map('map', {zoomControl:false}).setView([51.16,71.47],12);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
L.control.zoom({position:'bottomleft'}).addTo(map);

let csvMarkersLayer = L.layerGroup().addTo(map);
let routeLayer = L.layerGroup().addTo(map);
let userMarker = null;
let followUser = true; // –∞–≤—Ç–æ—Ü–µ–Ω—Ç—Ä –ø—Ä–∏ GPS –≤–∫–ª—é—á–µ–Ω–Ω–æ–º
let csvData = [];
let csvFileName = '';
let userCoords = null; // [lat, lon]
let activeRouteCoords = []; // –º–∞—Å—Å–∏–≤ [ [lat,lon], ... ] —Å—Ç–∞—Ç—É—Å–∞ 0
let osrmOrder = []; // –ø–æ—Ä—è–¥–æ–∫ —Ç–æ—á–µ–∫ –∏–∑ trip
let navMode = false;
let watchId = null;
let lastRouteTime = 0; // throttle
const ROUTE_THROTTLE_MS = 1200; // –º–∏–Ω–∏–º—É–º –º–µ–∂–¥—É –≤—ã–∑–æ–≤–∞–º–∏ OSRM
const ARRIVAL_THRESHOLD_M = 20; // —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –≤ –º–µ—Ç—Ä–∞—Ö —á—Ç–æ–±—ã –ø–æ–º–µ—Ç–∏—Ç—å —Ç–æ—á–∫—É –ø–æ—Å–µ—â—ë–Ω–Ω–æ–π
let nextWaypointIndex = 0; // –∏–Ω–¥–µ–∫—Å –≤ osrmOrder –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –∞–∫—Ç–∏–≤–Ω–æ–π —Ç–æ—á–∫–∏

const infoDistanceEl = document.getElementById('info-distance');
const infoDurationEl = document.getElementById('info-duration');
const infoNextPoint = document.getElementById('next-point');
const navStateEl = document.getElementById('nav-state');

/* ====================
   –£—Ç–∏–ª–∏—Ç—ã
   ==================== */
// –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≥—Ä–∞–¥—É—Å–æ–≤ -> —Ä–∞–¥–∏–∞–Ω—ã
function toRad(v){ return v * Math.PI / 180; }
// Haversine –≤ –º–µ—Ç—Ä–∞—Ö
function haversine([lat1,lon1],[lat2,lon2]){
  const R = 6371000;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}
// Debounce simple (not used widely, kept)
function now(){ return (new Date()).getTime(); }

/* ====================
   –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   ==================== */
function setUserMarker(coords){
  if(!coords) return;
  userCoords = coords;
  if(!userMarker){
    userMarker = L.circleMarker(coords, {radius:7, color:'#0077cc', fillColor:'#0077cc', fillOpacity:0.9}).addTo(map).bindPopup('–í—ã –∑–¥–µ—Å—å');
  } else {
    userMarker.setLatLng(coords);
  }
  if(followUser) map.setView(coords, Math.max(map.getZoom(), 15));
}

/* ====================
   –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É
   ==================== */
document.getElementById('centerUserBtn').addEventListener('click', ()=>{
  if(userCoords){ followUser = true; map.setView(userCoords, 15); }
});

/* ====================
   GPS: –≤–∫–ª—é—á–µ–Ω–∏–µ, –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ
   ==================== */
function startWatchPosition(){
  if(!navigator.geolocation){ alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ'); return; }
  if(watchId !== null) return; // —É–∂–µ –∏–¥–µ—Ç
  watchId = navigator.geolocation.watchPosition(position=> {
    const coords = [position.coords.latitude, position.coords.longitude];
    setUserMarker(coords);
    // –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Ä–µ–∞–ª—å–Ω–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω—É–∂–Ω–æ –ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç (throttle)
    const t = now();
    if(t - lastRouteTime > ROUTE_THROTTLE_MS){
      lastRouteTime = t;
      if(activeRouteCoords.length){
        // –ø–µ—Ä–µ—Å—á–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞ –∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –Ω–æ–≤–æ–π –ª–∏–Ω–∏–∏
        buildOptimizedRoute(true); // true ‚Äî –≤—ã–∑–≤–∞–Ω–æ GPS –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
      }
    }
    // –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Å–ª–µ–¥—É—é—â–µ–π —Ç–æ—á–∫–∏
    checkArrivalToNext();
  }, err => {
    alert('–û—à–∏–±–∫–∞ GPS: ' + (err.message || err.code));
  }, {enableHighAccuracy:true, maximumAge:1000, timeout:8000});
}

function stopWatchPosition(){
  if(watchId !== null){
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
  }
}

/* ====================
   –†–∞–±–æ—Ç–∞ —Å CSV –∏ –º–∞—Ä–∫–µ—Ä–∞–º–∏
   ==================== */
function clearAll(){
  csvMarkersLayer.clearLayers();
  routeLayer.clearLayers();
  csvData = [];
  csvFileName = '';
  activeRouteCoords = [];
  osrmOrder = [];
  nextWaypointIndex = 0;
  infoDistanceEl.textContent='–î–ª–∏–Ω–∞: ‚Äî';
  infoDurationEl.textContent='–í—Ä–µ–º—è: ‚Äî';
  infoNextPoint.textContent='‚Äî';
  navStateEl.textContent='–°–æ—Å—Ç–æ—è–Ω–∏–µ: –æ–∂–∏–¥–∞–Ω–∏–µ';
}

function createPopup(point, marker, index){
  // –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
  const container = document.createElement('div');
  container.style.display='flex';
  container.style.flexDirection='column';
  container.style.gap='6px';
  container.style.fontSize='13px';

  // lat/lon + –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å
  const latDiv = document.createElement('div');
  latDiv.style.display='flex'; latDiv.style.gap='6px';
  const latInput = document.createElement('input');
  latInput.type='text';
  latInput.value = `${point.lat}, ${point.lon}`;
  latInput.readOnly = true;
  latInput.style.border = 'none';
  latInput.style.background = 'transparent';
  latInput.style.flexGrow = '1';
  latInput.style.fontSize = '13px';
  const copyBtn = document.createElement('button');
  copyBtn.textContent = 'üìã'; copyBtn.title = '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
  copyBtn.addEventListener('click', ()=> {
    navigator.clipboard.writeText(latInput.value);
    copyBtn.textContent = '‚úî';
    setTimeout(()=> copyBtn.textContent = 'üìã', 900);
  });
  latDiv.appendChild(latInput); latDiv.appendChild(copyBtn);
  container.appendChild(latDiv);

  // status (0/1) ‚Äî —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π
  const statusDiv = document.createElement('div');
  statusDiv.style.display = 'flex'; statusDiv.style.gap = '6px'; statusDiv.style.alignItems = 'center';
  const statusLabel = document.createElement('span'); statusLabel.textContent = 'status:';
  const statusInput = document.createElement('input');
  statusInput.type='number'; statusInput.value = String(point.status); statusInput.min=0; statusInput.max=1;
  statusInput.style.width='64px';
  const saveBtn = document.createElement('button'); saveBtn.textContent='‚úÖ'; saveBtn.style.display='none';
  const cancelBtn = document.createElement('button'); cancelBtn.textContent='‚ùå'; cancelBtn.style.display='none';
  let original = String(point.status);

  statusInput.addEventListener('input', ()=>{
    const v = String(statusInput.value);
    if(v !== original) { saveBtn.style.display='inline-block'; cancelBtn.style.display='inline-block'; }
    else { saveBtn.style.display='none'; cancelBtn.style.display='none'; }
  });

  saveBtn.addEventListener('click', ()=>{
    const v = String(statusInput.value);
    if(v !== '0' && v !== '1'){ statusInput.value = original; saveBtn.style.display='none'; cancelBtn.style.display='none'; return; }
    point.status = v;
    csvData[index].status = v;
    original = v;
    // –ø–æ–º–µ–Ω—è—Ç—å —Ü–≤–µ—Ç –º–∞—Ä–∫–µ—Ä–∞
    marker.setStyle({color: v==='0' ? 'red' : 'green', fillColor: v==='0' ? 'red' : 'green'});
    saveBtn.style.display='none'; cancelBtn.style.display='none';
    // –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç
    buildOptimizedRoute();
  });

  cancelBtn.addEventListener('click', ()=>{
    statusInput.value = original; saveBtn.style.display='none'; cancelBtn.style.display='none';
  });

  statusDiv.appendChild(statusLabel); statusDiv.appendChild(statusInput); statusDiv.appendChild(saveBtn); statusDiv.appendChild(cancelBtn);
  container.appendChild(statusDiv);

  // comment
  const commentDiv = document.createElement('div');
  commentDiv.style.display='flex'; commentDiv.style.flexDirection='column'; commentDiv.style.gap='6px';
  const commentLabel = document.createElement('span'); commentLabel.textContent='comment:';
  const commentInput = document.createElement('textarea'); commentInput.rows=2; commentInput.style.width='100%'; commentInput.value = point.comment || '';
  const commentSave = document.createElement('button'); commentSave.textContent='üíæ'; commentSave.style.display='none';
  const commentCancel = document.createElement('button'); commentCancel.textContent='‚ùå'; commentCancel.style.display='none';
  let origComment = point.comment || '';

  commentInput.addEventListener('input', ()=>{
    if(commentInput.value !== origComment){ commentSave.style.display='inline-block'; commentCancel.style.display='inline-block'; }
    else { commentSave.style.display='none'; commentCancel.style.display='none'; }
  });

  commentSave.addEventListener('click', ()=>{
    point.comment = commentInput.value; csvData[index].comment = commentInput.value; origComment = commentInput.value;
    commentSave.style.display='none'; commentCancel.style.display='none';
  });

  commentCancel.addEventListener('click', ()=> {
    commentInput.value = origComment; commentSave.style.display='none'; commentCancel.style.display='none';
  });

  commentDiv.appendChild(commentLabel); commentDiv.appendChild(commentInput); commentDiv.appendChild(commentSave); commentDiv.appendChild(commentCancel);
  container.appendChild(commentDiv);

  return container;
}
<script>
/* ====================
   –ó–∞–≥—Ä—É–∑–∫–∞ CSV –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤
   ==================== */
document.getElementById('csvFile').addEventListener('change', function(ev){
  const file = ev.target.files[0];
  if(!file) return;
  csvFileName = file.name;
  Papa.parse(file, { header:true, dynamicTyping:false, skipEmptyLines:true,
    complete: function(results){
      const data = results.data || [];
      csvData = [];
      csvMarkersLayer.clearLayers();
      routeLayer.clearLayers();
      activeRouteCoords = [];
      osrmOrder = [];
      nextWaypointIndex = 0;

      data.forEach((r, i) => {
        // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π —Å—Ç–æ–ª–±—Ü–æ–≤
        const lat = r.lat !== undefined ? Number(r.lat) : (r.latitude !== undefined ? Number(r.latitude) : null);
        const lon = r.lon !== undefined ? Number(r.lon) : (r.longitude !== undefined ? Number(r.longitude) : null);
        if(lat === null || lon === null || Number.isNaN(lat) || Number.isNaN(lon)) return;
        const status = (String(r.status) === '1') ? '1' : '0';
        const comment = r.comment || '';
        const point = { lat, lon, status, comment };
        csvData.push(point);
        const color = status === '0' ? 'red' : 'green';
        const marker = L.circleMarker([lat, lon], { radius:6, color:color, fillColor:color, fillOpacity:0.85 }).addTo(csvMarkersLayer);
        marker.bindPopup(createPopup(point, marker, csvData.length-1), {minWidth:180});
      });

      // –°–æ–±–∏—Ä–∞–µ–º activeRouteCoords
      activeRouteCoords = csvData.filter(p => String(p.status) === '0').map(p => [Number(p.lat), Number(p.lon)]);
      if(activeRouteCoords.length) buildOptimizedRoute();
    }
  });
});

/* ====================
   –°–±–æ—Ä –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è OSRM Trip
   - —Å—é–¥–∞ –ø–æ–ø–∞–¥–∞–µ—Ç —Ç–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–∞–∫ –ø–µ—Ä–≤–∞—è —Ç–æ—á–∫–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
   - –æ—Å—Ç–∞–ª—å–Ω—ã–µ ‚Äî –≤—Å–µ activeRouteCoords
   ==================== */
function buildOptimizedRoute(triggeredByGPS = false){
  // –û—á–∏—Å—Ç–∏–º —Å—Ç–∞—Ä—É—é –ª–∏–Ω–∏—é
  routeLayer.clearLayers();
  osrmOrder = [];
  nextWaypointIndex = 0;
  infoNextPoint.textContent = '‚Äî';
  infoDistanceEl.textContent='–î–ª–∏–Ω–∞: ‚Äî';
  infoDurationEl.textContent='–í—Ä–µ–º—è: ‚Äî';
  navStateEl.textContent = '–ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –º–∞—Ä—à—Ä—É—Ç...';

  // –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç–æ—á–µ–∫
  activeRouteCoords = csvData.filter(p => String(p.status) === '0').map(p => [Number(p.lat), Number(p.lon)]);
  if(activeRouteCoords.length === 0){
    navStateEl.textContent = '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç–æ—á–µ–∫';
    return;
  }

  // –°–±–æ—Ä –≤—Å–µ—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç: –µ—Å–ª–∏ –µ—Å—Ç—å userCoords ‚Äî —Å—Ç–∞–≤–∏–º –µ–≥–æ –≤ –Ω–∞—á–∞–ª–æ (source=first)
  const coordsForTrip = userCoords ? [userCoords, ...activeRouteCoords] : activeRouteCoords.slice();
  const coordStr = coordsForTrip.map(c => `${c[1]},${c[0]}`).join(';');

  // –ó–∞–ø—Ä–æ—Å –∫ OSRM Trip ‚Äî –ø–æ–ª—É—á–∏–º –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –∏ –≥–µ–æ–º–µ—Ç—Ä–∏—é
  fetch(`https://router.project-osrm.org/trip/v1/driving/${coordStr}?source=first&roundtrip=false&overview=full&geometries=geojson`)
    .then(r => r.json())
    .then(json => {
      if(!json || !json.trips || !json.trips.length){
        throw new Error('OSRM –Ω–µ –≤–µ—Ä–Ω—É–ª –º–∞—Ä—à—Ä—É—Ç');
      }
      const trip = json.trips[0];
      // –ù–∞—Ä–∏—Å—É–µ–º –ª–∏–Ω–∏—é –º–∞—Ä—à—Ä—É—Ç–∞
      const geo = trip.geometry;
      L.geoJSON(geo, { style:{ color:'#ff3b30', weight:4, opacity:0.95 } }).addTo(routeLayer);

      // –ü–æ–ª—É—á–∏–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –∏ –≤—Ä–µ–º—è
      const distanceKm = (trip.distance/1000).toFixed(2);
      infoDistanceEl.textContent = `–î–ª–∏–Ω–∞: ${distanceKm} –∫–º`;
      const totalMinutes = Math.round(trip.duration/60);
      infoDurationEl.textContent = totalMinutes < 60 ? `${totalMinutes} –º–∏–Ω` : `${Math.floor(totalMinutes/60)} —á ${totalMinutes%60} –º–∏–Ω`;

      // OSRM –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç waypoints —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏ –≤ –ø–µ—Ä–µ–¥–∞–Ω–Ω–æ–º –º–∞—Å—Å–∏–≤–µ coordsForTrip:
      // –µ—Å–ª–∏ –º—ã –ø–µ—Ä–µ–¥–∞–ª–∏ userCoords –ø–µ—Ä–≤—ã–º ‚Äî waypoint index 0 –±—É–¥–µ—Ç user
      // —Å–æ—Å—Ç–∞–≤–∏–º –ø–æ—Ä—è–¥–æ–∫ —Ç–æ—á–µ–∫, –∏—Å–∫–ª—é—á–∞—è –≤–æ–∑–º–æ–∂–Ω—ã–π –ø–µ—Ä–≤—ã–π –ø—É–Ω–∫—Ç (user)
      const waypoints = json.waypoints || [];
      // waypoints[i].waypoint_index ‚Äî –∏–Ω–¥–µ–∫—Å –ø–æ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–π —Ç—Ä–∞—Å—Å–µ, .trips_index? might vary
      // simpler: osrm.trips[0].waypoints –Ω–µ –≤—Å–µ–≥–¥–∞ –µ—Å—Ç—å; –∏—Å–ø–æ–ª—å–∑—É–µ–º trip.waypoint_indices –µ—Å–ª–∏ –µ—Å—Ç—å
      // –ù–æ —Å–∞–º—ã–π –Ω–∞–¥—ë–∂–Ω—ã–π —Å–ø–æ—Å–æ–±: OSRM –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç trips[0].geometry; –ø–æ—Ä—è–¥–æ–∫ —Ç–æ—á–µ–∫ ‚Äî –≤ waypoints[].waypoint_index maps to coordsForTrip index
      // We'll construct osrmOrder as indices into activeRouteCoords (0..N-1)
      // Find mapping from coordsForTrip index -> activeRouteCoords index (if user present, shift by -1)
      const coordsCount = coordsForTrip.length;
      // Build mapping from returned 'waypoints' (in input order) to their input index
      // Many OSRM responses include 'waypoints' array where 'waypoint_index' is the index in input coords
      // We'll fallback: order by 'trips[0].legs' is not necessarily mapping to points; to keep robust, use 'waypoints' if present
      osrmOrder = [];
      if(Array.isArray(waypoints) && waypoints.length > 0){
        // Sort waypoints by their 'waypoint_index' in the trip order (property 'trips_index' absent) ‚Äî we use waypoint.index in input
        // But OSRM gives 'waypoint_index' (index into input) and 'location'
        // We need the sequence excluding user's point (if present)
        // Build map from input index (0..coordsForTrip-1) -> position in trip by 'waypoint_index'
        // Simpler: iterate over waypoints and for each find its input index; for each waypoint, if inputIndex>0 (i.e. not user), push activeRouteCoords[inputIndex-1]
        waypoints.forEach(wp => {
          const inputIndex = wp.waypoint_index !== undefined ? wp.waypoint_index : null;
          if(inputIndex === null) return;
          // if we have userCoords in beginning (user present at coordsForTrip[0]) then indices of points in activeRouteCoords are inputIndex-1
          if(userCoords){
            if(inputIndex === 0) return; // skip user
            const idx = inputIndex - 1;
            if(idx >=0 && idx < activeRouteCoords.length) osrmOrder.push(idx);
          } else {
            // no user ‚Äî direct mapping
            const idx = inputIndex;
            if(idx >=0 && idx < activeRouteCoords.length) osrmOrder.push(idx);
          }
        });
      }
      // If osrmOrder still empty (fallback) ‚Äî make naive order (0..N-1)
      if(!osrmOrder.length){
        osrmOrder = activeRouteCoords.map((_,i)=>i);
      }

      // –æ–ø—Ä–µ–¥–µ–ª–∏ nextWaypointIndex ‚Äî –±–ª–∏–∂–∞–π—à–∞—è –µ—â—ë –Ω–µ –ø–æ—Å–µ—â—ë–Ω–Ω–∞—è —Ç–æ—á–∫–∞ –≤ –ø–æ—Ä—è–¥–∫–µ osrmOrder
      nextWaypointIndex = 0;
      // –µ—Å–ª–∏ userCoords –µ—Å—Ç—å, –º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ –±–ª–∏–∂–∞–π –∏–∑ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è
      if(userCoords){
        // –∏—â–µ–º –±–ª–∏–∂–∞–π –ø–æ –ø–æ—Ä—è–¥–∫—É: –∏–¥—ë–º –ø–æ osrmOrder –∏ –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π whose distance > ARRIVAL_THRESHOLD
        for(let k=0;k<osrmOrder.length;k++){
          const pt = activeRouteCoords[osrmOrder[k]];
          const d = haversine(userCoords, pt);
          if(d > ARRIVAL_THRESHOLD_M) { nextWaypointIndex = k; break; }
          // –µ—Å–ª–∏ –≤—Å–µ —Ç–æ—á–∫–∏ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö ‚Äî –ø–æ–º–µ—Ç–∏–º –≤—Å–µ –∫–∞–∫ visited
          if(k === osrmOrder.length - 1) { nextWaypointIndex = osrmOrder.length; }
        }
      } else {
        nextWaypointIndex = 0;
      }

      // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–ª–µ–¥—É—é—â–µ–π —Ç–æ—á–∫–µ
      updateNextPointDisplay();

      navStateEl.textContent = '–ú–∞—Ä—à—Ä—É—Ç –≥–æ—Ç–æ–≤';
      // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –ø–æ –∂–µ–ª–∞–Ω–∏—é
      if(followUser && userCoords) map.setView(userCoords, Math.max(map.getZoom(), 15));
    })
    .catch(err => {
      console.error(err);
      navStateEl.textContent = '–û—à–∏–±–∫–∞ OSRM';
      alert('OSRM: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç');
    });
}

/* ====================
   –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Å–ª–µ–¥—É—é—â–µ–π —Ç–æ—á–∫–∏
   - –µ—Å–ª–∏ –¥–æ—à–ª–∏ –¥–æ —Ç–æ—á–∫–∏ (–º–µ–Ω—å—à–µ ARRIVAL_THRESHOLD_M) ‚Äî –ø–æ–º–µ—á–∞–µ–º –µ—ë status=1 –∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –º–∞—Ä—à—Ä—É—Ç
   ==================== */
function checkArrivalToNext(){
  if(!userCoords) return;
  if(!osrmOrder || osrmOrder.length === 0) return;
  if(nextWaypointIndex >= osrmOrder.length) return;
  const targetIdx = osrmOrder[nextWaypointIndex];
  const targetPoint = activeRouteCoords[targetIdx];
  if(!targetPoint) return;
  const dist = haversine(userCoords, targetPoint);
  // –µ—Å–ª–∏ –≤–Ω—É—Ç—Ä–∏ –ø–æ—Ä–æ–≥–∞ ‚Äî –æ—Ç–º–µ—á–∞–µ–º –∫–∞–∫ –ø–æ—Å–µ—â—ë–Ω–Ω—É—é
  if(dist <= ARRIVAL_THRESHOLD_M){
    // –ø–æ–º–µ—Ç–∏–º –≤ csvData: –Ω–∞–π—Ç–∏ —Ç–æ—á–∫—É —Å —Ç–∞–∫–∏–µ lat/lon –∏ —Å—Ç–∞—Ç—É—Å 0 ‚Äî –ø–æ–º–µ–Ω—è–µ–º –Ω–∞ 1
    let found = false;
    for(let i=0;i<csvData.length;i++){
      if(String(csvData[i].status) === '0' && Number(csvData[i].lat) === Number(targetPoint[0]) && Number(csvData[i].lon) === Number(targetPoint[1])){
        csvData[i].status = '1';
        found = true;
        break;
      }
    }
    if(found){
      // –æ–±–Ω–æ–≤–∏–º –º–∞—Ä–∫–µ—Ä —Ü–≤–µ—Ç–∞
      csvMarkersLayer.eachLayer(m => {
        const ll = m.getLatLng();
        if(Math.abs(ll.lat - targetPoint[0]) < 1e-7 && Math.abs(ll.lng - targetPoint[1]) < 1e-7){
          m.setStyle({color:'green', fillColor:'green'});
        }
      });
      navStateEl.textContent = `–¢–æ—á–∫–∞ ${nextWaypointIndex+1} –ø–æ—Å–µ—â–µ–Ω–∞`;
      // –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç (—É—á—Ç—ë—Ç, —á—Ç–æ —Ç–æ—á–∫–∞ —Å—Ç–∞–ª–∞ status=1)
      setTimeout(()=> buildOptimizedRoute(), 300);
    } else {
      // –µ—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –ø–æ —Ç–æ—á–Ω–æ—Å—Ç–∏ ‚Äî –≤—Å—ë —Ä–∞–≤–Ω–æ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–µ–º
      setTimeout(()=> buildOptimizedRoute(), 300);
    }
  }
}

</script>
<script>
/* ====================
   –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è: –ù–∞–≤–∏–≥–∞—Ü–∏—è, –°—Ç–æ–ø, –û–±–Ω–æ–≤–∏—Ç—å, –û—á–∏—Å—Ç–∏—Ç—å, –°–∫–∞—á–∞—Ç—å
   ==================== */
document.getElementById('locBtn').addEventListener('click', ()=>{
  followUser = true;
  startWatchPosition();
  navStateEl.textContent = 'GPS –≤–∫–ª—é—á–µ–Ω';
});
document.getElementById('stopNavBtn').addEventListener('click', ()=>{
  navMode = false;
  navStateEl.textContent = '–ù–∞–≤–∏–≥–∞—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞';
  // –Ω–µ –æ—Ç–∫–ª—é—á–∞–µ–º GPS ‚Äî —Ç–æ–ª—å–∫–æ –Ω–∞–≤–∏–≥–∞—Ü–∏—é –ª–æ–≥–∏—á–µ—Å–∫—É—é
});
document.getElementById('navigateBtn').addEventListener('click', ()=>{
  if(!csvData.length){ alert('–ù–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ç–æ—á–µ–∫'); return; }
  if(!userCoords){ if(confirm('GPS –Ω–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω. –í–∫–ª—é—á–∏—Ç—å GPS?')) { startWatchPosition(); } else { return; } }
  navMode = !navMode;
  navStateEl.textContent = navMode ? '–ù–∞–≤–∏–≥–∞—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞' : '–ù–∞–≤–∏–≥–∞—Ü–∏—è –≤—ã–∫–ª—é—á–µ–Ω–∞';
  if(navMode) {
    // –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ ‚Äî —Å—Ä–∞–∑—É –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç
    buildOptimizedRoute();
  }
});

document.getElementById('refreshBtn').addEventListener('click', ()=>{
  buildOptimizedRoute();
});

document.getElementById('clearBtn').addEventListener('click', ()=>{
  if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å GPS?')){
    clearAll();
    stopWatchPosition();
    if(userMarker){ map.removeLayer(userMarker); userMarker = null; userCoords = null; }
  }
});

document.getElementById('downloadBtn').addEventListener('click', ()=>{
  if(!csvData.length){ alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'); return; }
  // —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º csvData –≤ CSV –∏—Å–ø–æ–ª—å–∑—É—è Papa.unparse
  const csvText = Papa.unparse(csvData);
  const blob = new Blob([csvText], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = csvFileName || 'updated_points.csv';
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(url);
});

/* ====================
   –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ª–æ–≥–∏–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
   - –≤ –Ω–∞—à–µ–º –ø–æ–¥—Ö–æ–¥–µ "—Ä–µ–∞–ª—å–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è" ‚Äî —ç—Ç–æ:
     * GPS –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è (watchPosition)
     * –ø—Ä–∏ –∫–∞–∂–¥–æ–º (throttled) –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ -> –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç —Å —É—á—ë—Ç–æ–º —Ç–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏
     * –∫—Ä–∞—Å–Ω–∞—è –ª–∏–Ω–∏—è –Ω–∞ –∫–∞—Ä—Ç–µ –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç –æ—Ç –≤–∞—à–µ–≥–æ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª–æ–∂–µ–Ω–∏—è –¥–æ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è —Ç–æ—á–µ–∫ –≤ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
     * –ø—Ä–∏ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–∏ –∫ —Ç–æ—á–∫–µ (ARRIVAL_THRESHOLD_M) —Ç–æ—á–∫–∞ –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ –ø–æ—Å–µ—â—ë–Ω–Ω–∞—è (status=1) –∏ –º–∞—Ä—à—Ä—É—Ç –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è
   ==================== */

map.on('movestart zoomstart', ()=> { followUser = false; });

/* ====================
   –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å –∏–º—è —Å–ª–µ–¥—É—é—â–µ–π —Ç–æ—á–∫–∏
   ==================== */
function updateNextPointDisplay(){
  if(!osrmOrder || osrmOrder.length === 0){
    infoNextPoint.textContent = '‚Äî';
    return;
  }
  if(nextWaypointIndex >= osrmOrder.length){
    infoNextPoint.textContent = '–ù–ï–¢';
    return;
  }
  const idx = osrmOrder[nextWaypointIndex];
  const p = activeRouteCoords[idx];
  if(!p){ infoNextPoint.textContent = '‚Äî'; return; }
  infoNextPoint.textContent = `${p[0].toFixed(6)}, ${p[1].toFixed(6)}`;
}

/* ====================
   –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ‚Äî –µ—Å–ª–∏ –Ω—É–∂–Ω–æ, –º–æ–∂–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∫–ª—é—á–∞—Ç—å GPS
   ==================== */
// (–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –≤—ã–∫–ª—é—á–µ–Ω–Ω—ã–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
// startWatchPosition();

</script>
</body>
</html>
