<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Мобильный навигатор с OSRM Trip</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
html,body{margin:0;padding:0;height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
#map{height:100vh;width:100vw;}
#file-input{position:absolute;z-index:1200;left:50%;transform:translateX(-50%);top:10px;background:#fff;padding:6px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.15);display:flex;gap:6px;align-items:center;flex-wrap:wrap;max-width:95%;}
#nav-box{
  position:absolute;
  top:70px;
  left:50%;
  transform:translateX(-50%);
  z-index:1500;
  background:rgba(255,255,255,0.95);
  padding:8px 14px;
  border-radius:10px;
  box-shadow:0 2px 6px rgba(0,0,0,0.3);
  font-size:15px;
  text-align:center;
}
#info-box{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);z-index:1000;background:rgba(255,255,255,0.95);padding:6px 10px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,0.3);min-width:150px;text-align:center;font-size:14px;}
.leaflet-bottom .leaflet-control-zoom{top:50%;bottom:auto;transform:translateY(-50%);}
#centerUserBtn{position:absolute;bottom:80px;right:10px;z-index:1200;background:#fff;border:none;border-radius:50%;width:45px;height:45px;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,0.3);display:flex;justify-content:center;align-items:center;transition:transform 0.15s ease;}
#centerUserBtn:hover{transform:scale(1.1);}
#centerUserBtn svg{width:24px;height:24px;stroke:#0077cc;stroke-width:2;fill:none;}
textarea{resize:none;font-size:13px;}
</style>
</head>
<body>

<div id="file-input">
  <input type="file" id="csvFile" accept=".csv" />
  <button id="locBtn">GPS</button>
  <button id="refreshBtn">Обновить</button>
  <button id="clearBtn">Очистить</button>
  <button id="downloadBtn">Скачать</button>
</div>

<!-- НОВЫЙ БЛОК НАВИГАЦИИ -->
<div id="nav-box">Навигация: —</div>

<div id="info-box">
  <b>Маршрут</b><br>
  <span id="info-distance">Длина: —</span><br>
  <span id="info-duration">Время: —</span>
</div>

<div id="map"></div>

<button id="centerUserBtn">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
<circle cx="12" cy="12" r="10"/>
<line x1="12" y1="2" x2="12" y2="6"/>
<line x1="12" y1="18" x2="12" y2="22"/>
<line x1="2" y1="12" x2="6" y2="12"/>
<line x1="18" y1="12" x2="22" y2="12"/>
</svg>
</button>

<script>
const map = L.map('map', {zoomControl:false}).setView([51.16,71.47],12);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
L.control.zoom({position:'bottomleft'}).addTo(map);

let csvMarkersLayer=L.layerGroup().addTo(map);
let routeLayer=L.layerGroup().addTo(map);
let navigationLayer=L.layerGroup().addTo(map); // НОВЫЙ СЛОЙ

let userMarker=null;
let userCoords=null;
let autoFollow=true;

let csvData=[];
let activeRouteCoords=[];
let osrmCoords=[];

const navBox=document.getElementById("nav-box");

map.on('movestart zoomstart',()=>autoFollow=false);

function centerOnUser(z=16){
  if(userCoords) map.flyTo(userCoords,z,{duration:0.8});
}

function requestUserLocation(){
  navigator.geolocation.watchPosition(pos=>{
    userCoords=[pos.coords.latitude,pos.coords.longitude];
    updateUserMarker();
    runNavigation();
  },err=>console.log(err),{enableHighAccuracy:true});
}

function updateUserMarker(){
  if(!userMarker){
    userMarker=L.circleMarker(userCoords,{radius:6,color:"#0077cc",fillColor:"#0077cc",fillOpacity:0.9}).addTo(map);
  } else userMarker.setLatLng(userCoords);
  if(autoFollow) centerOnUser();
}

/* ======= НАВИГАЦИЯ ========= */

function getDistance(a,b){
  const R=6371e3;
  const toRad=x=>x*Math.PI/180;
  let dLat=toRad(b[0]-a[0]);
  let dLon=toRad(b[1]-a[1]);
  let lat1=toRad(a[0]);
  let lat2=toRad(b[0]);
  let h=Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(h));
}

function getBearing(a,b){
  const toRad=x=>x*Math.PI/180;
  const toDeg=x=>x*180/Math.PI;
  let dLon=toRad(b[1]-a[1]);
  let lat1=toRad(a[0]);
  let lat2=toRad(b[0]);
  let y=Math.sin(dLon)*Math.cos(lat2);
  let x=Math.cos(lat1)*Math.sin(lat2)-Math.sin(lat1)*Math.cos(lat2)*Math.cos(dLon);
  return (toDeg(Math.atan2(y,x))+360)%360;
}

function findNearestPoint(){
  if(!activeRouteCoords.length) return null;
  let best=null, bestDist=Infinity;
  activeRouteCoords.forEach(pt=>{
    let d=getDistance(userCoords,pt);
    if(d<bestDist){ bestDist=d; best=pt; }
  });
  return best;
}

function runNavigation(){
  if(!userCoords || !activeRouteCoords.length){
    navBox.textContent="Навигация: —";
    navigationLayer.clearLayers();
    return;
  }

  const nextPoint=findNearestPoint();
  if(!nextPoint){
    navBox.textContent="Навигация: —";
    navigationLayer.clearLayers();
    return;
  }

  const dist=Math.round(getDistance(userCoords,nextPoint));
  const bearing=getBearing(userCoords,nextPoint);

  let dir="";
  if(bearing<45 || bearing>=315) dir="↑ север";
  else if(bearing<135) dir="→ восток";
  else if(bearing<225) dir="↓ юг";
  else dir="← запад";

  navBox.textContent=`${dir} • ${dist} м`;

  navigationLayer.clearLayers();
  L.polyline([userCoords,nextPoint],{color:"red",weight:4}).addTo(navigationLayer);
}

/* ======== ОСНОВНОЙ КОД (НЕ МЕНЯЛ) ======== */

function buildOptimizedRoute(){
  routeLayer.clearLayers();

  activeRouteCoords = csvData.filter(p => p.status=="0").map(p => [Number(p.lat),Number(p.lon)]);
  osrmCoords=[...activeRouteCoords];

  if(!osrmCoords.length){ navBox.textContent="Маршрут пуст"; return; }

  const tripCoords = userCoords ? [userCoords, ...osrmCoords] : osrmCoords;
  const q = tripCoords.map(c=>`${c[1]},${c[0]}`).join(";");

  fetch(`https://router.project-osrm.org/trip/v1/driving/${q}?source=first&roundtrip=false&overview=full&geometries=geojson`)
    .then(r=>r.json())
    .then(j=>{
      if(!j.trips || !j.trips.length) return alert("OSRM ошибка");
      let t=j.trips[0];

      routeLayer.clearLayers();
      L.geoJSON(t.geometry,{style:{color:"#0077cc",weight:3}}).addTo(routeLayer);

      runNavigation();
    });
}

document.getElementById("csvFile").addEventListener("change",ev=>{
  const file=ev.target.files[0];
  Papa.parse(file,{header:true,complete:function(r){
    csvData=[];
    csvMarkersLayer.clearLayers();

    r.data.forEach((p,i)=>{
      const lat=p.lat, lon=p.lon;
      const status=p.status==="1"?"1":"0";
      csvData.push({lat,lon,status,comment:p.comment||""});
      const color=status==="0"?"red":"green";
      const m=L.circleMarker([lat,lon],{radius:6,color:color,fillColor:color,fillOpacity:0.8}).addTo(csvMarkersLayer);
    });

    buildOptimizedRoute();
  }});
});

document.getElementById("locBtn").onclick=requestUserLocation;
document.getElementById("refreshBtn").onclick=buildOptimizedRoute;
document.getElementById("clearBtn").onclick=()=>{csvData=[];routeLayer.clearLayers();};
</script>
</body>
</html>
