<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>–ú–æ–±–∏–ª—å–Ω—ã–π –Ω–∞–≤–∏–≥–∞—Ç–æ—Ä —Å OSRM Trip</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
html,body{margin:0;padding:0;height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
#map{height:100vh;width:100vw;}
#file-input{position:absolute;z-index:1200;left:50%;transform:translateX(-50%);top:10px;background:#fff;padding:6px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.15);display:flex;gap:6px;align-items:center;flex-wrap:wrap;max-width:95%;}
#file-input input[type=file]{font-size:13px;}
#file-input button{font-size:14px;padding:6px 8px;border-radius:6px;border:1px solid #ccc;background:#f7f7f7;cursor:pointer;}
#info-box{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);z-index:1000;background:rgba(255,255,255,0.95);padding:6px 10px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,0.3);min-width:150px;text-align:center;font-size:14px;}
.leaflet-bottom .leaflet-control-zoom{top:50%;bottom:auto;transform:translateY(-50%);}
#centerUserBtn{position:absolute;bottom:80px;right:10px;z-index:1200;background:#fff;border:none;border-radius:50%;width:45px;height:45px;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,0.3);display:flex;justify-content:center;align-items:center;transition:transform 0.15s ease;}
#centerUserBtn:hover{transform:scale(1.1);}
#centerUserBtn svg{width:24px;height:24px;stroke:#0077cc;stroke-width:2;fill:none;}
#version-label{position:absolute;bottom:10px;left:10px;color:#000;font-size:12px;z-index:1200;text-shadow:0 0 3px rgba(0,0,0,0.7);}
textarea{resize:none;font-size:13px;}
button{font-size:14px;padding:4px 6px;}

/* –ü–ª–∞–≤–Ω—ã–π –ø–æ–≤–æ—Ä–æ—Ç –∫–∞—Ä—Ç—ã */
.leaflet-map-pane {
  transition: transform 0.18s linear;
  transform-origin: 50% 50%;
}

/* –°—Ç–∏–ª—å –±–µ–ª–æ–≥–æ —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∞ (—É–∫–∞–∑—ã–≤–∞—é—â–µ–≥–æ –≤–≤–µ—Ä—Ö –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) */
.userTriangle {
  width: 0;
  height: 0;
  border-left: 10px solid transparent;
  border-right: 10px solid transparent;
  border-top: 18px solid white; /* —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫ —É–∫–∞–∑—ã–≤–∞–µ—Ç –≤–≤–µ—Ä—Ö */
  filter: drop-shadow(0 0 3px rgba(0,0,0,0.6));
  transform-origin: 50% 60%;
  /* —á—Ç–æ–±—ã —Ç—Ä–∏—É–≥–æ–ª—å–Ω–∏–∫ –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–ª —Ç–æ—á–Ω—É—é –ø–æ–∑–∏—Ü–∏—é ‚Äî –Ω–µ–º–Ω–æ–≥–æ —Å–¥–≤–∏–Ω–µ–º –≤–≤–µ—Ä—Ö —á–µ—Ä–µ–∑ margin */
  margin-top: -12px;
  margin-left: -0px;
  pointer-events: none;
}

/* –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–≤–æ—Ä–æ—Ç–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã —É –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Å–ª–æ—ë–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) */
.leaflet-control-container { transform-origin: 50% 50%; }

/* –ö–æ–≥–¥–∞ –Ω—É–∂–µ–Ω "—Å–∏–Ω–∏–π –∫—Ä—É–∂–æ–∫" ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å—Ç–∏–ª–∏ CircleMarker –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è */
</style>
</head>
<body>

<div id="file-input">
  <input type="file" id="csvFile" accept=".csv" />
  <button id="locBtn">GPS</button>
  <button id="refreshBtn">–û–±–Ω–æ–≤–∏—Ç—å</button>
  <button id="clearBtn">–û—á–∏—Å—Ç–∏—Ç—å</button>
  <button id="downloadBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  <button id="navStartBtn">–°—Ç–∞—Ä—Ç</button>
  <button id="navStopBtn">–°—Ç–æ–ø</button>
</div>

<div id="info-box">
  <b>–ú–∞—Ä—à—Ä—É—Ç</b><br>
  <span id="info-distance">–î–ª–∏–Ω–∞: ‚Äî</span><br>
  <span id="info-duration">–í—Ä–µ–º—è: ‚Äî</span>
</div>

<div id="map"></div>

<button id="centerUserBtn">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
<circle cx="12" cy="12" r="10"/>
<line x1="12" y1="2" x2="12" y2="6"/>
<line x1="12" y1="18" x2="12" y2="22"/>
<line x1="2" y1="12" x2="6" y2="12"/>
<line x1="18" y1="12" x2="22" y2="12"/>
</svg>
</button>

<div id="version-label">–≤–µ—Ä—Å–∏—è 3.0</div>

<script>
const map = L.map('map', {zoomControl:false}).setView([51.16,71.47],12);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
L.control.zoom({position:'bottomleft'}).addTo(map);

let csvMarkersLayer = L.layerGroup().addTo(map);
let routeLayer = L.layerGroup().addTo(map);
let userMarker = null;            // circle marker (—Å–∏–Ω–∏–π –∫—Ä—É–∂–æ–∫)
let userTriangleMarker = null;    // divIcon triangle
let autoFollow = true;
let csvData = [];
let csvFileName = '';
let userCoords = null;
let activeRouteCoords = [];
let osrmCoords = [];
let userRadius = null;

let navRouteCoords = [];
let navWatchId = null;
let remainingRouteLayer = null;

let mapRotationEnabled = false; // —Ñ–ª–∞–≥ ‚Äî –≤–∫–ª—é—á–µ–Ω–æ –ª–∏ –≤—Ä–∞—â–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã
let lastUserCoords = null;      // –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –∞–∑–∏–º—É—Ç–∞ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ heading
let lastHeading = 0;

const infoDistanceEl = document.getElementById('info-distance');
const infoDurationEl = document.getElementById('info-duration');

map.on('movestart zoomstart',()=>{autoFollow=false;});

function centerOnUser(zoom=15){ if(userCoords) map.flyTo(userCoords,zoom,{duration:1.0}); }

// ===== –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Ç–æ—á–µ–∫ –ø—Ä–∏ –ø–æ–ø–∞–¥–∞–Ω–∏–∏ –≤ —Ä–∞–¥–∏—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è =====
function checkPointsInUserRadius() {
  if(!userCoords) return;
  let changed = false;
  csvData.forEach((p,i)=>{
    if(p.status==="0"){
      const d = L.latLng(userCoords).distanceTo(L.latLng([p.lat,p.lon]));
      if(d <= 50){
        p.status="1";
        const layer = csvMarkersLayer.getLayers()[i];
        if(layer && layer.setStyle) layer.setStyle({color:'green', fillColor:'green'});
        changed = true;
      }
    }
  });
  if(changed) buildOptimizedRoute(); // –ø–µ—Ä–µ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç —Å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ–º —Ç–æ—á–µ–∫ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º 1
}

// –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨: –ø–æ–≤–æ—Ä–æ—Ç map pane
function rotateMap(angleDeg){
  const pane = document.querySelector('.leaflet-map-pane');
  if(!pane) return;
  pane.style.transform = `rotate(${angleDeg}deg)`;
}

// –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏–Ω–µ–≥–æ –∫—Ä—É–∂–∫–∞
function createOrUpdateUserCircle(lat, lon){
  if(userTriangleMarker){
    try{ map.removeLayer(userTriangleMarker); }catch(e){}
    userTriangleMarker = null;
  }
  if(!userMarker){
    userMarker = L.circleMarker([lat,lon],{radius:6,color:'#0077cc',fillColor:'#0077cc',fillOpacity:0.8}).addTo(map).bindPopup('–í—ã –∑–¥–µ—Å—å');
  } else {
    userMarker.setLatLng([lat,lon]);
    // –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–º —Å—Ç–∏–ª—å –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –æ–Ω –º–µ–Ω—è–ª—Å—è
    userMarker.setStyle({radius:6,color:'#0077cc',fillColor:'#0077cc',fillOpacity:0.8});
  }
}

// –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∞ (divIcon)
function createOrUpdateUserTriangle(lat, lon){
  // —É–¥–∞–ª—è–µ–º —Å–∏–Ω–∏–π –∫—Ä—É–∂–æ–∫
  if(userMarker){
    try{ map.removeLayer(userMarker); }catch(e){}
    userMarker = null;
  }
  const html = '<div class="userTriangle"></div>';
  const icon = L.divIcon({
    html: html,
    className: '', // –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–ª–∞—Å—Å –≤ html
    iconSize: [24,24],
    iconAnchor: [12,12]
  });
  if(!userTriangleMarker){
    userTriangleMarker = L.marker([lat, lon], {icon: icon, interactive:false}).addTo(map);
  } else {
    userTriangleMarker.setIcon(icon);
    userTriangleMarker.setLatLng([lat, lon]);
  }
}

// –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –∞–∑–∏–º—É—Ç–∞ (heading) –≤ –≥—Ä–∞–¥—É—Å–∞—Ö –æ—Ç —Å–µ–≤–µ—Äa (0..360)
// pos –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–±—ä–µ–∫—Ç –ø–æ–∑–∏—Ü–∏–∏ (pos.coords) –∏–ª–∏ –ø–∞—Ä–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
function computeHeadingFromCoords(prev, curr){
  // prev and curr are [lat, lon]
  const lat1 = prev[0] * Math.PI/180;
  const lon1 = prev[1] * Math.PI/180;
  const lat2 = curr[0] * Math.PI/180;
  const lon2 = curr[1] * Math.PI/180;
  const dLon = lon2 - lon1;
  const y = Math.sin(dLon) * Math.cos(lat2);
  const x = Math.cos(lat1)*Math.sin(lat2) - Math.sin(lat1)*Math.cos(lat2)*Math.cos(dLon);
  let brng = Math.atan2(y, x) * 180/Math.PI;
  brng = (brng + 360) % 360;
  return brng;
}

// ================= Build OSRM Route =================
function buildOptimizedRoute(){
  routeLayer.clearLayers();
  activeRouteCoords = csvData.filter(p => String(p.status) === "0").map(p => [Number(p.lat), Number(p.lon)]);
  osrmCoords = [...activeRouteCoords];

  if(osrmCoords.length === 0){
    infoDistanceEl.textContent='–î–ª–∏–Ω–∞: ‚Äî';
    infoDurationEl.textContent='–í—Ä–µ–º—è: ‚Äî';
    navRouteCoords = [];
    if(remainingRouteLayer){ remainingRouteLayer.clearLayers(); remainingRouteLayer=null; }
    return;
  }

  const tripCoords = userCoords ? [userCoords, ...osrmCoords] : osrmCoords;
  const coordStr = tripCoords.map(c => `${c[1]},${c[0]}`).join(';');

  fetch(`https://router.project-osrm.org/trip/v1/driving/${coordStr}?source=first&roundtrip=false&overview=full&geometries=geojson`)
    .then(r=>r.json())
    .then(json=>{
      if(!json.trips || !json.trips.length){ alert('OSRM –Ω–µ —Å–º–æ–≥ –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç'); return; }
      const trip = json.trips[0];
      routeLayer.clearLayers();
      L.geoJSON(trip.geometry,{style:{color:'#0077cc',weight:3,opacity:0.9}}).addTo(routeLayer);
      navRouteCoords = trip.geometry.coordinates.map(c => [c[1],c[0]]);
      const distanceKm = (trip.distance/1000).toFixed(2);
      infoDistanceEl.textContent = `–î–ª–∏–Ω–∞: ${distanceKm} –∫–º`;
      const totalMinutes = Math.round(trip.duration/60);
      infoDurationEl.textContent = totalMinutes<60?`${totalMinutes} –º–∏–Ω`:`${Math.floor(totalMinutes/60)} —á ${totalMinutes%60} –º–∏–Ω`;
      if(userCoords) centerOnUser(15);
    })
    .catch(err=>{ alert('–û—à–∏–±–∫–∞ OSRM'); console.error(err); });
}

// ================= CREATE POPUP =================
function createPopup(point, marker, index){
  const container=document.createElement('div');
  container.style.display='flex'; container.style.flexDirection='column'; container.style.gap='4px';
  container.style.fontSize='14px';

  // LAT/LON
  const latDiv=document.createElement('div');
  latDiv.style.display='flex'; latDiv.style.gap='4px';
  const latInput=document.createElement('input');
  latInput.type='text';
  latInput.value=`${point.lat}, ${point.lon}`;
  latInput.readOnly=true;
  latInput.style.border='none';
  latInput.style.background='transparent';
  latInput.style.flexGrow='1';
  latInput.style.fontSize='13px';
  const copyBtn=document.createElement('button');
  copyBtn.textContent='üìã';
  copyBtn.title='–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
  copyBtn.style.fontSize='14px';
  copyBtn.addEventListener('click',()=>{ navigator.clipboard.writeText(latInput.value); copyBtn.textContent='‚úî'; setTimeout(()=>copyBtn.textContent='üìã',1000); });
  latDiv.appendChild(latInput); latDiv.appendChild(copyBtn); container.appendChild(latDiv);

  // STATUS
  const statusDiv = document.createElement('div');
  statusDiv.style.display = 'flex';
  statusDiv.style.flexDirection = 'column';
  statusDiv.style.gap = '4px';
  const statusLabel = document.createElement('span'); statusLabel.textContent = 'status:';
  const btnContainer = document.createElement('div'); btnContainer.style.display='flex'; btnContainer.style.gap='4px';
  const btn0 = document.createElement('button'); btn0.textContent='–í –ø—Ä–æ—Ü–µ—Å—Å–µ';
  const btn1 = document.createElement('button'); btn1.textContent='–í—ã–ø–æ–ª–Ω–µ–Ω–æ';
  [btn0, btn1].forEach(b => { b.style.fontSize='14px'; b.style.flex='1'; });
  let originalValue = String(point.status);
  function updateButtons() { 
    if(originalValue==='0'){ btn0.style.background='#0077cc'; btn0.style.color='#fff'; btn1.style.background=''; btn1.style.color=''; }
    else { btn1.style.background='#0077cc'; btn1.style.color='#fff'; btn0.style.background=''; btn0.style.color=''; }
  }
  updateButtons();
  const saveBtn = document.createElement('button'); saveBtn.textContent='üíæ'; saveBtn.style.display='none'; saveBtn.style.fontSize='14px';
  const cancelBtn = document.createElement('button'); cancelBtn.textContent='‚ùå'; cancelBtn.style.display='none'; cancelBtn.style.fontSize='14px';
  btn0.addEventListener('click',()=>{ originalValue='0'; updateButtons(); saveBtn.style.display='inline-block'; cancelBtn.style.display='inline-block'; });
  btn1.addEventListener('click',()=>{ originalValue='1'; updateButtons(); saveBtn.style.display='inline-block'; cancelBtn.style.display='inline-block'; });
  saveBtn.addEventListener('click',()=>{
    point.status = originalValue;
    csvData[index].status = originalValue;
    marker.setStyle({color: originalValue==='0'?'red':'green', fillColor: originalValue==='0'?'red':'green'});
    saveBtn.style.display='none'; cancelBtn.style.display='none';
    buildOptimizedRoute();
  });
  cancelBtn.addEventListener('click',()=>{ originalValue = point.status; updateButtons(); saveBtn.style.display='none'; cancelBtn.style.display='none'; });
  btnContainer.appendChild(btn0); btnContainer.appendChild(btn1);
  statusDiv.appendChild(statusLabel); statusDiv.appendChild(btnContainer); statusDiv.appendChild(saveBtn); statusDiv.appendChild(cancelBtn);
  container.appendChild(statusDiv);

  // COMMENT
  const commentDiv=document.createElement('div');
  commentDiv.style.display='flex'; commentDiv.style.flexDirection='column'; commentDiv.style.gap='4px';
  const commentLabel=document.createElement('span'); commentLabel.textContent='comment:';
  const commentInput=document.createElement('textarea'); commentInput.value=point.comment||""; commentInput.rows=2; commentInput.style.width='100%'; commentInput.style.fontSize='13px';
  const commentSave=document.createElement('button'); commentSave.textContent='üíæ'; commentSave.style.display='none'; commentSave.style.fontSize='14px';
  const commentCancel=document.createElement('button'); commentCancel.textContent='‚ùå'; commentCancel.style.display='none'; commentCancel.style.fontSize='14px';
  let originalComment = point.comment || "";
  commentInput.addEventListener('input',()=>{
    if(commentInput.value !== originalComment){ commentSave.style.display='inline-block'; commentCancel.style.display='inline-block'; } 
    else{ commentSave.style.display='none'; commentCancel.style.display='none'; }
  });
  commentSave.addEventListener('click',()=>{
    point.comment = commentInput.value; csvData[index].comment = commentInput.value; originalComment = commentInput.value;
    commentSave.style.display='none'; commentCancel.style.display='none';
  });
  commentCancel.addEventListener('click',()=>{ commentInput.value = originalComment; commentSave.style.display='none'; commentCancel.style.display='none'; });
  commentDiv.appendChild(commentLabel); commentDiv.appendChild(commentInput); commentDiv.appendChild(commentSave); commentDiv.appendChild(commentCancel);
  container.appendChild(commentDiv);

  return container;
}

// ================= EVENTS =================
document.getElementById('csvFile').addEventListener('change', function(ev){
  const file=ev.target.files[0]; if(!file) return; csvFileName=file.name;
  Papa.parse(file,{header:true,dynamicTyping:false,skipEmptyLines:true,complete:function(results){
    const data=results.data||[]; 
    csvData=[]; 
    csvMarkersLayer.clearLayers(); 
    routeLayer.clearLayers();
    activeRouteCoords=[]; 
    osrmCoords=[];
    data.forEach((r,i)=>{
      const lat=r.lat!==undefined?r.lat:r.latitude;
      const lon=r.lon!==undefined?r.lon:r.longitude;
      const status = (String(r.status) === "1") ? "1" : "0";
      const comment=r.comment||"";
      csvData.push({lat,lon,status,comment});
      const color=status==="0"?'red':'green';
      const marker=L.circleMarker([lat,lon],{radius:6,color:color,fillColor:color,fillOpacity:0.8}).addTo(csvMarkersLayer);
      marker.bindPopup(createPopup(csvData[i],marker,i),{minWidth:160});
    });
    buildOptimizedRoute();
  }});
});

document.getElementById('downloadBtn').addEventListener('click', ()=>{
  if(!csvData.length){ alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'); return; }
  const csv=Papa.unparse(csvData);
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob); 
  const link=document.createElement('a'); 
  link.href=url; 
  link.download=csvFileName||'updated.csv';
  document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url);
});

document.getElementById('locBtn').addEventListener('click',()=>{ autoFollow=true; requestUserLocation(); });
document.getElementById('refreshBtn').addEventListener('click',()=>{ buildOptimizedRoute(); });
document.getElementById('clearBtn').addEventListener('click',()=>{ 
  csvMarkersLayer.clearLayers(); 
  routeLayer.clearLayers(); 
  if(remainingRouteLayer){ remainingRouteLayer.clearLayers(); remainingRouteLayer=null; }
  document.getElementById('csvFile').value=''; 
  csvData=[]; activeRouteCoords=[]; osrmCoords=[]; navRouteCoords=[]; 
  infoDistanceEl.textContent='–î–ª–∏–Ω–∞: ‚Äî'; 
  infoDurationEl.textContent='–í—Ä–µ–º—è: ‚Äî'; 
});
document.getElementById('centerUserBtn').addEventListener('click',()=>{ if(userCoords){ autoFollow=true; centerOnUser(); } });

// ================= REAL GPS NAVIGATION =================
function startRealNavigation(){
  if(!navRouteCoords.length){ alert('–ù–µ—Ç –º–∞—Ä—à—Ä—É—Ç–∞ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏'); return; }
  if(!navigator.geolocation){ alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è'); return; }
  // –≤–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º –ø–æ–≤–æ—Ä–æ—Ç–∞ –∫–∞—Ä—Ç—ã –∏ —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∞
  mapRotationEnabled = true;

  // —Å–æ–∑–¥–∞—ë–º —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫ –≤–º–µ—Å—Ç–æ –∫—Ä—É–∂–∫–∞ –≤ —Ç–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
  if(userCoords) createOrUpdateUserTriangle(userCoords[0], userCoords[1]);
  if(navWatchId) navigator.geolocation.clearWatch(navWatchId);
  if(!remainingRouteLayer) remainingRouteLayer = L.layerGroup().addTo(map);

  navWatchId = navigator.geolocation.watchPosition(pos=>{
    // –æ–±–Ω–æ–≤–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    const prevCoords = userCoords ? [userCoords[0], userCoords[1]] : null;
    userCoords=[lat,lon];

    // –æ–±–Ω–æ–≤–ª—è–µ–º –ª–∏–±–æ —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫, –ª–∏–±–æ –∫—Ä—É–∂–æ–∫ (–≤ —Ä–µ–∂–∏–º–µ nav –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫)
    if(mapRotationEnabled){
      createOrUpdateUserTriangle(lat, lon);
    } else {
      createOrUpdateUserCircle(lat, lon);
    }

    if(!userRadius) userRadius = L.circle(userCoords,{radius:50,color:'black',weight:1,fillOpacity:0}).addTo(map);
    else userRadius.setLatLng(userCoords);

    checkPointsInUserRadius();

    if(autoFollow) centerOnUser();

    // –≤—ã—á–∏—Å–ª—è–µ–º heading
    let heading = null;
    if(pos.coords.heading !== null && !isNaN(pos.coords.heading)){
      heading = pos.coords.heading; // degree from north
    } else if(prevCoords){
      // –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–≤–µ —Ç–æ—á–∫–∏ –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
      heading = computeHeadingFromCoords(prevCoords, [lat,lon]);
    } else {
      heading = lastHeading || 0;
    }
    lastHeading = heading;

    // –ü–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –∫–∞—Ä—Ç—É —Ç–∞–∫, —á—Ç–æ–±—ã –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è –±—ã–ª–æ "–≤–≤–µ—Ä—Ö"
    if(mapRotationEnabled && typeof heading === 'number'){
      // rotate map pane by negative heading (so that heading points up)
      rotateMap(-heading);
      // the triangle is a DOM element inside rotated pane; since we rotated the pane
      // and the triangle's default points up, it will appear pointing in movement direction (up).
      // ensure marker is at updated coords
      if(userTriangleMarker) userTriangleMarker.setLatLng([lat, lon]);
    }

    // –û—Å—Ç–∞—Ç–æ–∫ –º–∞—Ä—à—Ä—É—Ç–∞ –∫—Ä–∞—Å–Ω–æ–π –ª–∏–Ω–∏–µ–π
    if(navRouteCoords.length>0){
      let nearestIndex=0, minDist=Infinity;
      for(let i=0;i<navRouteCoords.length;i++){
        const dx=userCoords[0]-navRouteCoords[i][0], dy=userCoords[1]-navRouteCoords[i][1];
        const dist=Math.sqrt(dx*dx+dy*dy);
        if(dist<minDist){ minDist=dist; nearestIndex=i; }
      }
      remainingRouteLayer.clearLayers();
      let points=[[userCoords[0],userCoords[1]], navRouteCoords[nearestIndex]];
      L.polyline(points,{color:'red',weight:3,opacity:0.9}).addTo(remainingRouteLayer);
      let remainingPoints=navRouteCoords.slice(nearestIndex);
      L.polyline(remainingPoints,{color:'red',weight:3,opacity:0.9}).addTo(remainingRouteLayer);
    
      // –ñ—ë–ª—Ç–∞—è –ª–∏–Ω–∏—è 200–º
      let yellowLineCoords=[[userCoords[0],userCoords[1]]];
      let distAccum = 0;
      for(let i=nearestIndex; i<navRouteCoords.length-1; i++){
        const from = L.latLng(navRouteCoords[i]);
        const to = L.latLng(navRouteCoords[i+1]);
        const segDist = from.distanceTo(to);
        if(distAccum + segDist > 200){
          const remaining = 200 - distAccum;
          const ratio = remaining/segDist;
          const latPart = from.lat + (to.lat - from.lat) * ratio;
          const lngPart = from.lng + (to.lng - from.lng) * ratio;
          yellowLineCoords.push([latPart,lngPart]);
          break;
        } else {
          yellowLineCoords.push([to.lat,to.lng]);
          distAccum += segDist;
        }
      }
      L.polyline(yellowLineCoords,{color:'yellow',weight:4,opacity:0.9}).addTo(remainingRouteLayer);
    }

    // —Å–æ—Ö—Ä–∞–Ω—è–µ–º prev
    lastUserCoords = [lat, lon];

  }, err=>{
    console.error(err);
    alert('–û—à–∏–±–∫–∞ GPS: ' + (err && err.message ? err.message : 'unknown'));
  }, {enableHighAccuracy:true, maximumAge:0, timeout:5000});
}

function stopRealNavigation(){ 
  // –æ—Ç–∫–ª—é—á–∞–µ–º watch –∏ –æ—á–∏—â–∞–µ–º —Å–ª–æ–π
  if(navWatchId){ navigator.geolocation.clearWatch(navWatchId); navWatchId=null; } 
  if(remainingRouteLayer){ remainingRouteLayer.clearLayers(); } 

  // –æ—Ç–∫–ª—é—á–∞–µ–º –≤—Ä–∞—â–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã
  mapRotationEnabled = false;
  rotateMap(0);

  // –≤–µ—Ä–Ω—É—Ç—å —Å–∏–Ω—é—é –º–µ—Ç–∫—É
  if(userTriangleMarker){
    try{ map.removeLayer(userTriangleMarker); }catch(e){}
    userTriangleMarker = null;
  }
  if(userCoords) createOrUpdateUserCircle(userCoords[0], userCoords[1]);
}

document.getElementById('navStartBtn').addEventListener('click', ()=>{
  // –µ—Å–ª–∏ –Ω–µ—Ç –º–∞—Ä—à—Ä—É—Ç–∞ ‚Äî –æ–ø–æ–≤–µ—â–∞–µ–º
  if(!navRouteCoords || navRouteCoords.length===0){
    alert('–ù–µ—Ç –º–∞—Ä—à—Ä—É—Ç–∞ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏');
    return;
  }
  // –≤–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ-—Å–ª–µ–∂–µ–Ω–∏–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
  autoFollow = true;
  startRealNavigation();
});

document.getElementById('navStopBtn').addEventListener('click', ()=>{
  stopRealNavigation();
  // —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–±–µ–∑ –≤—Ä–∞—â–µ–Ω–∏—è) –∏ —Å—Ç–∞–≤–∏–º —Å–µ–≤–µ—Ä –≤–≤–µ—Ä—Ö
  if(userCoords){
    map.setView(userCoords, map.getZoom());
  }
  // —Ç–∞–∫–∂–µ –º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å –∞–≤—Ç–æFollow = false; –Ω–æ –æ—Å—Ç–∞–≤–∏–º —Ç–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
});

// –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Ä—É—á–Ω—É—é —Ü–µ–Ω—Ç—Ä—É–µ—Ç ‚Äî –≤–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æFollow
document.getElementById('centerUserBtn').addEventListener('click',()=>{ if(userCoords){ autoFollow=true; centerOnUser(); } });

// ================= helper functions =================
function updateUserPosition(pos){ 
  userCoords=[pos.coords.latitude,pos.coords.longitude]; 
  // –ø—Ä–∏ –ø—Ä–æ—Å—Ç–æ–º –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ–∑–∏—Ü–∏–∏ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏–Ω–∏–π –∫—Ä—É–∂–æ–∫, –µ—Å–ª–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—è –Ω–µ –≤–∫–ª—é—á–µ–Ω–∞
  if(!mapRotationEnabled){
    if(!userMarker){ userMarker = L.circleMarker(userCoords,{radius:6,color:'#0077cc',fillColor:'#0077cc',fillOpacity:0.8}).addTo(map).bindPopup('–í—ã –∑–¥–µ—Å—å'); }
    else userMarker.setLatLng(userCoords);
  } else {
    // –µ—Å–ª–∏ —Ä–µ–∂–∏–º –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –≤–∫–ª—é—á–µ–Ω ‚Äî –æ–±–Ω–æ–≤–∏–º —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫
    createOrUpdateUserTriangle(userCoords[0], userCoords[1]);
  }
  if(!userRadius) userRadius = L.circle(userCoords,{radius:50,color:'black',weight:1,fillOpacity:0}).addTo(map);
  else userRadius.setLatLng(userCoords);
  checkPointsInUserRadius();
  if(autoFollow) centerOnUser(); 
}

function requestUserLocation(){ 
  if(!navigator.geolocation){alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');return;} 
  navigator.geolocation.getCurrentPosition(updateUserPosition,err=>alert('GPS –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'),{enableHighAccuracy:true}); 
}

</script>
</body>
</html>
